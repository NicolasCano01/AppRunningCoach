<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="Running Coach Pro - Training History Management">
  <meta name="theme-color" content="#0ea5e9">
  <title>Running Coach Pro - Session History V8</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700;9..40,800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  
  <style>
    :root {
      --bg-primary: #0a0f1a;
      --bg-secondary: #111827;
      --bg-card: #1a2332;
      --bg-elevated: #243044;
      --accent-blue: #3b82f6;
      --accent-cyan: #06b6d4;
      --accent-emerald: #10b981;
      --accent-amber: #f59e0b;
      --accent-rose: #f43f5e;
      --accent-purple: #8b5cf6;
      --text-primary: #f8fafc;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --border-color: #334155;
    }
    
    * { 
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      box-sizing: border-box;
    }
    
    .mono { font-family: 'Space Mono', monospace; }
    
    body {
      background: linear-gradient(135deg, var(--bg-primary) 0%, #0f172a 50%, #1e1b4b 100%);
      min-height: 100vh;
      color: var(--text-primary);
      margin: 0;
      padding: 0 0 80px 0;
    }

    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(26, 35, 50, 0.98);
      backdrop-filter: blur(20px);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding-bottom: env(safe-area-inset-bottom);
      z-index: 1000;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
    }
    
    .bottom-nav-container {
      display: flex;
      justify-content: space-around;
      align-items: center;
      max-width: 600px;
      margin: 0 auto;
      padding: 8px 16px;
    }
    
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 8px 12px;
      border-radius: 12px;
      text-decoration: none;
      color: var(--text-secondary);
      transition: all 0.2s;
      min-width: 60px;
      flex: 1;
      max-width: 90px;
    }
    
    .nav-item:hover {
      background: rgba(59, 130, 246, 0.1);
      color: var(--text-primary);
    }
    
    .nav-item.active {
      background: var(--accent-emerald);
      color: white;
    }
    
    .nav-item svg {
      width: 24px;
      height: 24px;
    }
    
    .nav-item span {
      font-size: 11px;
      font-weight: 600;
    }

    /* Cards & Layout */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .metric-card {
      background: rgba(59, 130, 246, 0.05);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 12px;
      padding: 12px;
    }

    .session-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .session-card:hover {
      border-color: var(--accent-blue);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
    }

    /* Badges */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-blue { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
    .badge-cyan { background: rgba(6, 182, 212, 0.2); color: #22d3ee; }
    .badge-emerald { background: rgba(16, 185, 129, 0.2); color: #34d399; }
    .badge-amber { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
    .badge-rose { background: rgba(244, 63, 94, 0.2); color: #fb7185; }
    .badge-purple { background: rgba(139, 92, 246, 0.2); color: #a78bfa; }

    /* Intensity Badge - NEW */
    .intensity-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 700;
      animation: pulse-glow 2s ease-in-out infinite;
    }

    .intensity-high {
      background: linear-gradient(135deg, rgba(244, 63, 94, 0.3), rgba(139, 92, 246, 0.3));
      border: 2px solid rgba(244, 63, 94, 0.5);
      color: #fda4af;
    }

    .intensity-moderate {
      background: linear-gradient(135deg, rgba(6, 182, 212, 0.3), rgba(16, 185, 129, 0.3));
      border: 2px solid rgba(6, 182, 212, 0.5);
      color: #67e8f9;
    }

    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 10px rgba(244, 63, 94, 0.3); }
      50% { box-shadow: 0 0 20px rgba(244, 63, 94, 0.5); }
    }

    /* Buttons */
    .btn {
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: none;
      font-size: 14px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
    }

    .btn-secondary {
      background: var(--bg-elevated);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--bg-card);
      border-color: var(--accent-blue);
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 13px;
    }

    /* Input Fields */
    .input-field {
      width: 100%;
      padding: 10px 14px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: 14px;
      transition: all 0.2s;
    }

    .input-field:focus {
      outline: none;
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .input-field:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Filter Pills */
    .filter-pill {
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      white-space: nowrap;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-pill:hover {
      border-color: var(--accent-blue);
      color: var(--text-primary);
    }

    .filter-pill.active {
      background: var(--accent-blue);
      border-color: var(--accent-blue);
      color: white;
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 16px;
    }

    .modal-content {
      background: var(--bg-secondary);
      border-radius: 20px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      border: 1px solid var(--border-color);
    }

    /* Spinner */
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(59, 130, 246, 0.2);
      border-top-color: var(--accent-blue);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Pagination */
    .pagination-btn {
      padding: 8px 14px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
    }

    .pagination-btn:hover:not(:disabled) {
      background: var(--bg-elevated);
      border-color: var(--accent-blue);
    }

    .pagination-btn.active {
      background: var(--accent-blue);
      border-color: var(--accent-blue);
      color: white;
    }

    .pagination-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    /* Collapsible */
    .collapsible-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .collapsible-content.expanded {
      max-height: 800px;
    }

    /* Auto-fill Info Box - NEW */
    .auto-fill-info {
      padding: 12px;
      border-radius: 12px;
      font-size: 13px;
      display: flex;
      align-items: start;
      gap: 10px;
      margin-top: 8px;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .auto-fill-info .icon {
      font-size: 20px;
      flex-shrink: 0;
    }

    /* Calculated TSS Display - NEW */
    .tss-display {
      padding: 12px 16px;
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(59, 130, 246, 0.15));
      border: 2px solid rgba(139, 92, 246, 0.3);
      border-radius: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
    }

    .tss-value {
      font-size: 24px;
      font-weight: 800;
      color: #a78bfa;
      font-family: 'Space Mono', monospace;
    }

    /* Responsive */
    @media (max-width: 640px) {
      .metric-card { padding: 10px; }
      .session-card { padding: 10px; }
      .session-card .flex { flex-wrap: wrap; }
      .modal-content { 
        max-width: 100%; 
        border-radius: 20px 20px 0 0;
        max-height: 95vh;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;
    
    const GARMIN_WORKER_URL = 'https://garmin-proxy.nicoca17.workers.dev/'; 
    const TRAINING_START_DATE = '2024-11-10';

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCQr84Yu0lTkKMnqtgYDD5NP4i_n5qS4eM",
      authDomain: "runningcoachdata.firebaseapp.com",
      projectId: "runningcoachdata",
      storageBucket: "runningcoachdata.firebasestorage.app",
      messagingSenderId: "364279562892",
      appId: "1:364279562892:web:7acd6bbac8c8113177f1a9"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();
    const auth = firebase.auth();

    // TSS Calculation Functions (from blueprint)
    const calculateTSS = (sessionType, formData) => {
      const duration = parseFloat(formData.duration) || 0;
      const distance = parseFloat(formData.distance) || 0;
      const rpe = parseFloat(formData.rpe) || 0;
      const routeType = formData.routeType || 'flat';

      if (sessionType === 'Futsal') {
        // Formula: (duration/60) Ã— 95 Ã— (RPE / 8)
        return ((duration / 60) * 95 * (rpe / 8)).toFixed(1);
      }
      
      if (sessionType === 'Pedicab') {
        // Formula: hours Ã— 12 Ã— routeMultiplier
        const hours = duration / 60;
        const routeMultiplier = routeType === 'hilly' ? 1.3 : 1.0;
        return (hours * 12 * routeMultiplier).toFixed(1);
      }
      
      if (sessionType.includes('Run') && distance > 0 && rpe > 0) {
        // Formula: distance Ã— 6.5 Ã— (RPE / 6)
        return (distance * 6.5 * (rpe / 6)).toFixed(1);
      }

      if (sessionType === 'Strength Training') {
        return ((duration / 60) * 30).toFixed(1);
      }

      return 0;
    };

    // Bottom Navigation Component
    const BottomNav = ({ currentPage }) => (
      <nav className="bottom-nav">
        <div className="bottom-nav-container">
          <a href="AnalyticsPanel.html" className={`nav-item ${currentPage === 'analytics' ? 'active' : ''}`}>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <line x1="18" y1="20" x2="18" y2="10"></line>
              <line x1="12" y1="20" x2="12" y2="4"></line>
              <line x1="6" y1="20" x2="6" y2="14"></line>
            </svg>
            <span>Analytics</span>
          </a>
          
          <a href="HistoryPanel.html" className={`nav-item ${currentPage === 'history' ? 'active' : ''}`}>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            <span>History</span>
          </a>
          
          <a href="SmartCoachPanel.html" className={`nav-item ${currentPage === 'coach' ? 'active' : ''}`}>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <circle cx="12" cy="8" r="7"></circle>
              <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline>
            </svg>
            <span>Coach</span>
          </a>
          
          <a href="#" className="nav-item" onClick={(e) => { e.preventDefault(); window.openAddModal && window.openAddModal(); }}>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"></path>
              <rect x="9" y="3" width="6" height="4" rx="1"></rect>
              <line x1="12" y1="12" x2="12" y2="12.01"></line>
              <line x1="12" y1="16" x2="12" y2="16.01"></line>
            </svg>
            <span>Log</span>
          </a>
          
          <a href="#" className={`nav-item ${currentPage === 'settings' ? 'active' : ''}`} onClick={(e) => { e.preventDefault(); alert('Settings coming soon!'); }}>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M12 1v6m0 6v6m0-6h6m-6 0H6m13.66-5.66L16 10m-8 8-3.66 3.66M1.34 6.34L5 10m8 8 3.66 3.66M18.66 1.34 15 5M9 15l-3.66 3.66"></path>
            </svg>
            <span>Settings</span>
          </a>
        </div>
      </nav>
    );

    // Main Training History Component
    function TrainingHistory() {
      const [sessions, setSessions] = useState([]);
      const [loading, setLoading] = useState(true);
      const [searchTerm, setSearchTerm] = useState('');
      const [sessionTypeFilter, setSessionTypeFilter] = useState('All Types');
      const [phaseFilter, setPhaseFilter] = useState('All Phases');
      const [quickFilter, setQuickFilter] = useState('All');
      const [showAdvancedFilters, setShowAdvancedFilters] = useState(false);
      const [fromDate, setFromDate] = useState('');
      const [toDate, setToDate] = useState('');
      const [currentPage, setCurrentPage] = useState(1);
      const [selectedSessions, setSelectedSessions] = useState([]);
      
      // Modal state
      const [showModal, setShowModal] = useState(false);
      const [modalType, setModalType] = useState('view'); // 'view', 'add', 'edit'
      const [selectedSession, setSelectedSession] = useState(null);
      const [editingSession, setEditingSession] = useState(null);
      
      // NEW: Form state for prefilling
      const [currentSessionType, setCurrentSessionType] = useState('Easy Run');
      const [formData, setFormData] = useState({});
      const [calculatedTSS, setCalculatedTSS] = useState(0);
      
      // NEW: Temporary state for pace inputs (raw user input)
      const [paceInputs, setPaceInputs] = useState({
        avgPace: '',
        z2Pace: ''
      });
      
      const sessionsPerPage = 20;

      const sessionTypes = ['All Types', 'Easy Run', 'Long Run', 'Tempo Run', 'Speed Intervals', 'Recovery Run', 'Futsal', 'Pedicab', 'Strength Training', 'Cross-Training'];
      const phases = ['All Phases', 'Base', 'Build', 'Specialty', 'Taper'];

      // Helper functions
      const parseSessionDate = (dateStr) => {
        if (!dateStr) return new Date();
        if (dateStr.includes('/')) {
          const [day, month, year] = dateStr.split('/');
          return new Date(`${year}-${month}-${day}`);
        }
        return new Date(dateStr);
      };

      const formatPace = (seconds) => {
        if (!seconds || seconds === 0) return '--:--';
        const mins = Math.floor(seconds / 60);
        const secs = Math.round(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
      };

      const paceToSeconds = (mmss) => {
        if (!mmss) return null; // Allow empty
        if (!mmss.includes(':')) return null; // Keep null while typing
        const [mins, secs] = mmss.split(':').map(Number);
        if (isNaN(mins) || isNaN(secs)) return null;
        return mins * 60 + secs;
      };

      const formatDate = (dateStr) => {
        const date = parseSessionDate(dateStr);
        return date.toLocaleDateString('en-AU', { day: '2-digit', month: 'short', year: 'numeric' });
      };

      const getSessionIcon = (type) => {
        const icons = {
          'Pedicab': 'ðŸš´',
          'Futsal': 'âš½',
          'Easy Run': 'ðŸƒ',
          'Long Run': 'ðŸƒâ€â™‚ï¸',
          'Speed Intervals': 'âš¡',
          'Tempo Run': 'ðŸ”¥',
          'Cross-Training': 'ðŸ‹ï¸',
          'Recovery Run': 'ðŸ’¤',
          'Strength Training': 'ðŸ’ª'
        };
        return icons[type] || 'ðŸƒ';
      };

      // NEW: Get default values based on session type
      const getSessionDefaults = (sessionType) => {
        switch (sessionType) {
          case 'Futsal':
            return {
              duration: 60,
              distance: null,
              avgPace: null,
              avgHr: 165,
              maxHr: 185,
              rpe: 8,
              intensityFactor: 1.05,
              routeType: null
            };
          case 'Pedicab':
            return {
              duration: 360, // 6 hours in minutes
              distance: null,
              avgPace: null,
              avgHr: 120,
              maxHr: 145,
              rpe: 5,
              intensityFactor: 0.65,
              routeType: 'flat'
            };
          default:
            return {
              duration: null,
              distance: null,
              avgPace: null,
              avgHr: null,
              maxHr: null,
              rpe: null,
              intensityFactor: null,
              routeType: null
            };
        }
      };

      // NEW: Update TSS when form data changes
      useEffect(() => {
        const tss = calculateTSS(currentSessionType, formData);
        setCalculatedTSS(tss);
      }, [currentSessionType, formData]);

      // Load sessions from Firebase
      const loadSessions = async () => {
        try {
          await auth.signInWithEmailAndPassword('nic@runningcoach.com', 'policias');
          
          const user = auth.currentUser;
          if (!user) throw new Error('Not authenticated');

          const sessionsRef = db.collection('users').doc(user.uid).collection('sessions');
          const snapshot = await sessionsRef.orderBy('date', 'desc').get();
          
          const trainingStartDate = new Date('2025-11-10');
          const loadedSessions = snapshot.docs.map(doc => {
            const sessionData = doc.data();
            const sessionDate = parseSessionDate(sessionData.date);
            const daysSinceStart = Math.floor((sessionDate - trainingStartDate) / (1000 * 60 * 60 * 24));
            const weekNumber = Math.floor(daysSinceStart / 7) + 1;
            
            return {
              id: doc.id,
              ...sessionData,
              weekNumber: weekNumber > 0 ? weekNumber : 1
            };
          });

          setSessions(loadedSessions);
          console.log(`âœ… Firestore: Loaded ${loadedSessions.length} sessions`);
          setLoading(false);
        } catch (error) {
          console.error('âŒ Error:', error);
          setLoading(false);
        }
      };

      useEffect(() => {
        loadSessions();
      }, []);

      // Apply filters
      const filteredSessions = useMemo(() => {
        let filtered = [...sessions];

        const now = new Date();
        if (quickFilter === 'Last 7 Days') {
          const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
          filtered = filtered.filter(s => parseSessionDate(s.date) >= sevenDaysAgo);
        } else if (quickFilter === 'Last 30') {
          const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
          filtered = filtered.filter(s => parseSessionDate(s.date) >= thirtyDaysAgo);
        }

        if (searchTerm) {
          const term = searchTerm.toLowerCase();
          filtered = filtered.filter(s =>
            (s.notes && s.notes.toLowerCase().includes(term)) ||
            (s.route && s.route.toLowerCase().includes(term)) ||
            (s.sessionType && s.sessionType.toLowerCase().includes(term))
          );
        }

        if (sessionTypeFilter !== 'All Types') {
          filtered = filtered.filter(s => s.sessionType === sessionTypeFilter);
        }

        if (phaseFilter !== 'All Phases') {
          filtered = filtered.filter(s => s.phase === phaseFilter);
        }

        if (fromDate) {
          const from = new Date(fromDate);
          filtered = filtered.filter(s => parseSessionDate(s.date) >= from);
        }

        if (toDate) {
          const to = new Date(toDate);
          to.setHours(23, 59, 59, 999);
          filtered = filtered.filter(s => parseSessionDate(s.date) <= to);
        }

        return filtered;
      }, [sessions, searchTerm, sessionTypeFilter, phaseFilter, quickFilter, fromDate, toDate]);

      // Summary stats
      const summaryStats = useMemo(() => {
        // Safely convert to number, handling both strings and numbers
        const toNumber = (val) => {
          if (val === null || val === undefined) return 0;
          const num = parseFloat(val);
          return isNaN(num) ? 0 : num;
        };

        const totalDistance = filteredSessions.reduce((sum, s) => sum + toNumber(s.distance), 0);
        const totalTime = filteredSessions.reduce((sum, s) => sum + toNumber(s.duration), 0);
        const hrSessions = filteredSessions.filter(s => s.avgHr);
        const avgHR = hrSessions.length > 0 ? Math.round(hrSessions.reduce((sum, s) => sum + toNumber(s.avgHr), 0) / hrSessions.length) : 0;
        const rpeSessions = filteredSessions.filter(s => s.rpe);
        const avgRPE = rpeSessions.length > 0 ? (rpeSessions.reduce((sum, s) => sum + toNumber(s.rpe), 0) / rpeSessions.length).toFixed(1) : 0;

        return {
          totalSessions: filteredSessions.length,
          totalDistance: totalDistance.toFixed(1),
          totalTime,
          avgHR,
          avgRPE
        };
      }, [filteredSessions]);

      // Session type breakdown
      const sessionTypeBreakdown = useMemo(() => {
        const breakdown = {};
        filteredSessions.forEach(s => {
          breakdown[s.sessionType] = (breakdown[s.sessionType] || 0) + 1;
        });
        return Object.entries(breakdown).sort((a, b) => b[1] - a[1]);
      }, [filteredSessions]);

      // Pagination
      const paginatedSessions = useMemo(() => {
        const startIndex = (currentPage - 1) * sessionsPerPage;
        return filteredSessions.slice(startIndex, startIndex + sessionsPerPage);
      }, [filteredSessions, currentPage]);

      const totalPages = Math.ceil(filteredSessions.length / sessionsPerPage);

      // Modal actions
      const openAddModal = () => {
        const defaults = getSessionDefaults('Easy Run');
        setCurrentSessionType('Easy Run');
        setEditingSession(null);
        setFormData({
          ...defaults,
          date: new Date().toISOString().split('T')[0],
          phase: 'Base'
        });
        setPaceInputs({ avgPace: '', z2Pace: '' });
        setModalType('add');
        setShowModal(true);
      };

      const openViewModal = (session) => {
        setSelectedSession(session);
        setModalType('view');
        setShowModal(true);
      };

      const closeModal = () => {
        setShowModal(false);
        setSelectedSession(null);
        setEditingSession(null);
        setCurrentSessionType('Easy Run');
        setFormData({});
        setPaceInputs({ avgPace: '', z2Pace: '' });
        setCalculatedTSS(0);
      };

      // NEW: Handle session type change in form
      const handleSessionTypeChange = (newType) => {
        setCurrentSessionType(newType);
        const defaults = getSessionDefaults(newType);
        
        // If editing, preserve existing values, otherwise use defaults
        if (editingSession && editingSession.sessionType === newType) {
          setFormData({
            ...defaults,
            ...editingSession
          });
        } else {
          setFormData(defaults);
        }
      };

      // NEW: Handle individual form field changes
      const handleFormChange = (field, value) => {
        setFormData(prev => ({
          ...prev,
          [field]: value
        }));
      };

      // Save session
      const handleSaveSession = async () => {
        try {
          const sessionType = document.getElementById('modalSessionType').value;
          const date = formData.date;
          const phase = formData.phase;

          if (!date || !phase) {
            alert('Please fill in all required fields (Date, Phase)');
            return;
          }

          let sessionData = {
            sessionType,
            date,
            phase,
            ...formData
          };

          // Special handling for Pedicab hours
          if (sessionType === 'Pedicab') {
            const pedicabHours = parseFloat(document.getElementById('modalPedicabHours').value) || 6;
            sessionData.duration = pedicabHours * 60;
            sessionData.pedicabHours = pedicabHours;
          }

          // CRITICAL FIX: Convert all numeric fields to actual numbers
          const numericFields = ['distance', 'duration', 'avgPace', 'avgHr', 'maxHr', 'rpe', 
                                 'intensityFactor', 'z2Pace', 'z2Time', 'avgCadence', 'pedicabHours'];
          numericFields.forEach(field => {
            if (sessionData[field] !== undefined && sessionData[field] !== null && sessionData[field] !== '') {
              const numValue = parseFloat(sessionData[field]);
              if (!isNaN(numValue) && numValue > 0) {
                sessionData[field] = numValue;
              } else {
                // If can't convert to valid number, remove the field
                delete sessionData[field];
              }
            }
          });

          // Clean up null/empty values
          Object.keys(sessionData).forEach(key => {
            if (sessionData[key] === null || sessionData[key] === '' || sessionData[key] === undefined) {
              delete sessionData[key];
            }
          });

          // Add TSS if calculated
          if (calculatedTSS > 0) {
            sessionData.estimatedTSS = parseFloat(calculatedTSS);
          }

          const user = auth.currentUser;
          if (modalType === 'add') {
            await db.collection('users').doc(user.uid).collection('sessions').add(sessionData);
            console.log('âœ… Session added');
          } else {
            await db.collection('users').doc(user.uid).collection('sessions').doc(editingSession.id).update(sessionData);
            console.log('âœ… Session updated');
          }

          await loadSessions();
          closeModal();
        } catch (error) {
          console.error('âŒ Save error:', error);
          alert('Failed to save session');
        }
      };

      // Delete session
      const handleDeleteSession = async (sessionId) => {
        if (!confirm('Are you sure you want to delete this session? This action cannot be undone.')) {
          return;
        }

        try {
          const user = auth.currentUser;
          await db.collection('users').doc(user.uid).collection('sessions').doc(sessionId).delete();
          console.log('âœ… Session deleted');
          await loadSessions();
          closeModal();
        } catch (error) {
          console.error('âŒ Delete error:', error);
          alert('Failed to delete session');
        }
      };

      // Delete session
      const deleteSession = async (sessionId) => {
        if (!confirm('Are you sure you want to delete this session?')) return;
        
        try {
          const user = auth.currentUser;
          await db.collection('users').doc(user.uid).collection('sessions').doc(sessionId).delete();
          setSessions(prev => prev.filter(s => s.id !== sessionId));
          console.log('âœ… Session deleted');
        } catch (error) {
          console.error('âŒ Delete error:', error);
          alert('Failed to delete session');
        }
      };

      // Expose openAddModal globally for nav button
      useEffect(() => {
        window.openAddModal = openAddModal;
        return () => { window.openAddModal = null; };
      }, []);

      if (loading) {
        return (
          <div className="flex items-center justify-center min-h-screen">
            <div className="text-center">
              <div className="spinner mx-auto mb-4"></div>
              <p className="text-slate-400">Loading sessions...</p>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen">
          {/* Header */}
          <div className="p-4 md:p-6">
            <div className="flex items-center justify-between mb-2">
              <h1 className="text-2xl md:text-3xl font-bold flex items-center gap-2">
                ðŸ“… Training History
              </h1>
            </div>
            <p className="text-sm text-slate-400">Manage and track all your training sessions</p>
          </div>

          {/* Main Content */}
          <div className="px-4 md:px-6 pb-6 space-y-4">
            
            {/* Quick Filters */}
            <div className="flex gap-2 overflow-x-auto pb-2">
              {['Last 7 Days', 'Last 30', 'All'].map(filter => (
                <button
                  key={filter}
                  className={`filter-pill ${quickFilter === filter ? 'active' : ''}`}
                  onClick={() => { setQuickFilter(filter); setCurrentPage(1); }}
                >
                  {filter}
                </button>
              ))}
              <button
                className="filter-pill"
                onClick={() => setShowAdvancedFilters(!showAdvancedFilters)}
              >
                {showAdvancedFilters ? 'â–²' : 'â–¼'} Advanced
              </button>
            </div>

            {/* Advanced Filters */}
            <div className={`collapsible-content ${showAdvancedFilters ? 'expanded' : ''}`}>
              <div className="card p-4 space-y-3">
                <div>
                  <label className="block text-xs font-semibold text-slate-400 mb-1">Search</label>
                  <input
                    type="text"
                    placeholder="Search notes, routes..."
                    className="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-lg text-sm text-white focus:border-blue-500 focus:outline-none"
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                  />
                </div>

                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="block text-xs font-semibold text-slate-400 mb-1">Session Type</label>
                    <select
                      className="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-lg text-sm text-white focus:border-blue-500 focus:outline-none"
                      value={sessionTypeFilter}
                      onChange={(e) => setSessionTypeFilter(e.target.value)}
                    >
                      {sessionTypes.map(type => (
                        <option key={type} value={type}>{type}</option>
                      ))}
                    </select>
                  </div>

                  <div>
                    <label className="block text-xs font-semibold text-slate-400 mb-1">Phase</label>
                    <select
                      className="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-lg text-sm text-white focus:border-blue-500 focus:outline-none"
                      value={phaseFilter}
                      onChange={(e) => setPhaseFilter(e.target.value)}
                    >
                      {phases.map(phase => (
                        <option key={phase} value={phase}>{phase}</option>
                      ))}
                    </select>
                  </div>
                </div>

                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="block text-xs font-semibold text-slate-400 mb-1">From Date</label>
                    <input
                      type="date"
                      className="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-lg text-sm text-white focus:border-blue-500 focus:outline-none"
                      value={fromDate}
                      onChange={(e) => setFromDate(e.target.value)}
                    />
                  </div>

                  <div>
                    <label className="block text-xs font-semibold text-slate-400 mb-1">To Date</label>
                    <input
                      type="date"
                      className="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded-lg text-sm text-white focus:border-blue-500 focus:outline-none"
                      value={toDate}
                      onChange={(e) => setToDate(e.target.value)}
                    />
                  </div>
                </div>

                <button
                  className="btn btn-secondary btn-small w-full"
                  onClick={() => {
                    setSearchTerm('');
                    setSessionTypeFilter('All Types');
                    setPhaseFilter('All Phases');
                    setFromDate('');
                    setToDate('');
                    setQuickFilter('All');
                  }}
                >
                  âœ• Clear Filters
                </button>
              </div>
            </div>

            {/* Summary Stats */}
            <div className="card p-4">
              <h3 className="text-sm font-semibold text-slate-400 mb-3">
                ðŸ“Š Summary ({summaryStats.totalSessions} sessions)
              </h3>
              <div className="grid grid-cols-2 gap-3">
                <div className="metric-card">
                  <h4 className="text-xs text-slate-400 mb-1">Total Distance</h4>
                  <div className="text-2xl font-bold text-cyan-400">{summaryStats.totalDistance} km</div>
                </div>

                <div className="metric-card">
                  <h4 className="text-xs text-slate-400 mb-1">Total Time</h4>
                  <div className="text-2xl font-bold text-emerald-400">{(summaryStats.totalTime / 60).toFixed(1)} hrs</div>
                </div>

                <div className="metric-card">
                  <h4 className="text-xs text-slate-400 mb-1">Avg Heart Rate</h4>
                  <div className="text-2xl font-bold text-rose-400">{summaryStats.avgHR || '--'} bpm</div>
                </div>

                <div className="metric-card">
                  <h4 className="text-xs text-slate-400 mb-1">Avg RPE</h4>
                  <div className="text-2xl font-bold text-amber-400">{summaryStats.avgRPE}/10</div>
                </div>
              </div>
            </div>

            {/* Session Type Badges */}
            {sessionTypeBreakdown.length > 0 && (
              <div className="flex flex-wrap gap-2">
                {sessionTypeBreakdown.map(([type, count]) => {
                  const badgeColors = ['badge-blue', 'badge-cyan', 'badge-emerald', 'badge-amber', 'badge-purple', 'badge-rose'];
                  const color = badgeColors[sessionTypeBreakdown.indexOf([type, count]) % badgeColors.length];
                  return (
                    <span key={type} className={`badge ${color}`}>
                      {getSessionIcon(type)} {type} {count}
                    </span>
                  );
                })}
              </div>
            )}

            {/* Add Session Button */}
            <div className="flex justify-between items-center">
              <button className="btn btn-primary" onClick={openAddModal}>
                <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2">
                  <circle cx="10" cy="10" r="9"></circle>
                  <line x1="10" y1="6" x2="10" y2="14"></line>
                  <line x1="6" y1="10" x2="14" y2="10"></line>
                </svg>
                Add Session
              </button>
              
              <div className="text-sm text-slate-400">
                Page {currentPage} of {totalPages || 1}
              </div>
            </div>

            {/* Sessions List */}
            <div className="space-y-3">
              {paginatedSessions.length === 0 ? (
                <div className="card p-8 text-center">
                  <p className="text-slate-400 text-lg">No sessions found</p>
                  <p className="text-slate-500 text-sm mt-2">Try adjusting your filters or add a new session</p>
                </div>
              ) : (
                paginatedSessions.map(session => (
                  <div
                    key={session.id}
                    className="session-card"
                    onClick={() => openViewModal(session)}
                  >
                    <div className="flex justify-between items-start mb-2">
                      <div className="flex items-center gap-2">
                        <span className="text-2xl">{getSessionIcon(session.sessionType)}</span>
                        <div>
                          <h3 className="font-bold text-white">{session.sessionType}</h3>
                          <p className="text-xs text-slate-400">{formatDate(session.date)}</p>
                        </div>
                      </div>
                      <span className="badge badge-blue">{session.phase}</span>
                    </div>

                    <div className="grid grid-cols-4 gap-2 text-sm">
                      <div>
                        <div className="text-slate-400 text-xs">Distance</div>
                        <div className="font-semibold text-cyan-400">{(parseFloat(session.distance) || 0).toFixed(1)} km</div>
                      </div>
                      <div>
                        <div className="text-slate-400 text-xs">Duration</div>
                        <div className="font-semibold text-emerald-400">{Math.round(parseFloat(session.duration) || 0)} min</div>
                      </div>
                      <div>
                        <div className="text-slate-400 text-xs">Pace</div>
                        <div className="font-semibold text-indigo-400 mono">{formatPace(session.avgPace)}</div>
                      </div>
                      <div>
                        <div className="text-slate-400 text-xs">RPE</div>
                        <div className="font-semibold text-amber-400">{session.rpe || '--'}/10</div>
                      </div>
                    </div>

                    {session.notes && (
                      <p className="text-sm text-slate-400 mt-2 line-clamp-1">{session.notes}</p>
                    )}
                  </div>
                ))
              )}
            </div>

            {/* Pagination */}
            {totalPages > 1 && (
              <div className="flex justify-center items-center gap-2 flex-wrap">
                <button
                  className="pagination-btn"
                  onClick={() => setCurrentPage(prev => Math.max(1, prev - 1))}
                  disabled={currentPage === 1}
                >
                  â€¹ Prev
                </button>

                {[...Array(totalPages)].map((_, i) => {
                  const pageNum = i + 1;
                  if (
                    pageNum === 1 ||
                    pageNum === totalPages ||
                    (pageNum >= currentPage - 1 && pageNum <= currentPage + 1)
                  ) {
                    return (
                      <button
                        key={pageNum}
                        className={`pagination-btn ${currentPage === pageNum ? 'active' : ''}`}
                        onClick={() => setCurrentPage(pageNum)}
                      >
                        {pageNum}
                      </button>
                    );
                  } else if (pageNum === currentPage - 2 || pageNum === currentPage + 2) {
                    return <span key={pageNum} className="text-slate-500">...</span>;
                  }
                  return null;
                })}

                <button
                  className="pagination-btn"
                  onClick={() => setCurrentPage(prev => Math.min(totalPages, prev + 1))}
                  disabled={currentPage === totalPages}
                >
                  Next â€º
                </button>
              </div>
            )}
          </div>

          {/* View Modal */}
          {showModal && modalType === 'view' && selectedSession && (
            <div className="modal-backdrop" onClick={closeModal}>
              <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                {/* Header */}
                <div className="p-4 border-b border-slate-700 flex items-center justify-between">
                  <div>
                    <h2 className="text-xl font-bold flex items-center gap-2">
                      {getSessionIcon(selectedSession.sessionType)} {selectedSession.sessionType}
                    </h2>
                    <p className="text-sm text-slate-400">{formatDate(selectedSession.date)} â€¢ {selectedSession.phase}</p>
                  </div>
                  <button onClick={closeModal} className="text-slate-400 hover:text-white text-2xl">Ã—</button>
                </div>

                {/* Content */}
                <div className="p-4 space-y-4">
                  {/* Performance Metrics */}
                  <div className="grid grid-cols-2 gap-3">
                    <div className="metric-card">
                      <h4 className="text-xs text-slate-400 mb-1">Distance</h4>
                      <div className="text-xl font-bold text-cyan-400">{(parseFloat(selectedSession.distance) || 0).toFixed(1)} km</div>
                    </div>
                    <div className="metric-card">
                      <h4 className="text-xs text-slate-400 mb-1">Duration</h4>
                      <div className="text-xl font-bold text-emerald-400">{Math.round(parseFloat(selectedSession.duration) || 0)} min</div>
                    </div>
                    <div className="metric-card">
                      <h4 className="text-xs text-slate-400 mb-1">Avg Pace</h4>
                      <div className="text-xl font-bold text-indigo-400 mono">{formatPace(selectedSession.avgPace)}</div>
                    </div>
                    <div className="metric-card">
                      <h4 className="text-xs text-slate-400 mb-1">RPE</h4>
                      <div className="text-xl font-bold text-amber-400">{selectedSession.rpe || '--'}/10</div>
                    </div>
                  </div>

                  {/* Heart Rate */}
                  {(selectedSession.avgHr || selectedSession.maxHr) && (
                    <div className="grid grid-cols-2 gap-3">
                      {selectedSession.avgHr && (
                        <div className="metric-card">
                          <h4 className="text-xs text-slate-400 mb-1">Avg HR</h4>
                          <div className="text-xl font-bold text-rose-400">{selectedSession.avgHr} bpm</div>
                        </div>
                      )}
                      {selectedSession.maxHr && (
                        <div className="metric-card">
                          <h4 className="text-xs text-slate-400 mb-1">Max HR</h4>
                          <div className="text-xl font-bold text-rose-300">{selectedSession.maxHr} bpm</div>
                        </div>
                      )}
                    </div>
                  )}

                  {/* TSS Display */}
                  {selectedSession.estimatedTSS && (
                    <div className="card p-3 bg-purple-900/10 border-purple-700/30">
                      <div className="flex justify-between items-center">
                        <div className="text-sm text-purple-300 font-semibold">Training Stress Score</div>
                        <div className="text-2xl font-bold text-purple-400 mono">{selectedSession.estimatedTSS}</div>
                      </div>
                    </div>
                  )}

                  {/* Zone Data */}
                  {(selectedSession.z2Pace || selectedSession.z2Time || selectedSession.avgCadence) && (
                    <div className="card p-3 bg-blue-900/10 border-blue-700/30">
                      <h4 className="text-sm font-semibold text-blue-300 mb-2">Zone & Performance Data</h4>
                      <div className="grid grid-cols-2 gap-3 text-sm">
                        {selectedSession.z2Pace && (
                          <div>
                            <div className="text-slate-400">Z2 Pace</div>
                            <div className="font-semibold mono">{formatPace(selectedSession.z2Pace)}</div>
                          </div>
                        )}
                        {selectedSession.z2Time && (
                          <div>
                            <div className="text-slate-400">Time in Z2</div>
                            <div className="font-semibold">{selectedSession.z2Time} min</div>
                          </div>
                        )}
                        {selectedSession.avgCadence && (
                          <div>
                            <div className="text-slate-400">Avg Cadence</div>
                            <div className="font-semibold">{selectedSession.avgCadence} spm</div>
                          </div>
                        )}
                      </div>
                    </div>
                  )}

                  {/* Notes */}
                  {selectedSession.notes && (
                    <div className="card p-3 bg-slate-800/50">
                      <h4 className="text-sm font-semibold text-slate-300 mb-1">Notes</h4>
                      <p className="text-sm text-slate-400">{selectedSession.notes}</p>
                    </div>
                  )}
                </div>

                {/* Footer */}
                <div className="p-4 border-t border-slate-700 flex gap-2">
                  <button className="btn btn-primary flex-1" onClick={() => {
                    setModalType('edit');
                    setEditingSession(selectedSession);
                    setCurrentSessionType(selectedSession.sessionType);
                    const defaults = getSessionDefaults(selectedSession.sessionType);
                    setFormData({ 
                      ...defaults, 
                      ...selectedSession,
                      date: selectedSession.date || new Date().toISOString().split('T')[0],
                      phase: selectedSession.phase || 'Base'
                    });
                    // Initialize pace inputs with formatted values for editing
                    setPaceInputs({
                      avgPace: selectedSession.avgPace ? formatPace(selectedSession.avgPace) : '',
                      z2Pace: selectedSession.z2Pace ? formatPace(selectedSession.z2Pace) : ''
                    });
                  }}>
                    Edit Session
                  </button>
                  <button 
                    className="btn" 
                    style={{ background: 'linear-gradient(135deg, #ef4444, #dc2626)', color: 'white' }}
                    onClick={() => handleDeleteSession(selectedSession.id)}
                  >
                    Delete
                  </button>
                  <button className="btn btn-secondary" onClick={closeModal}>Close</button>
                </div>
              </div>
            </div>
          )}

          {/* Add/Edit Modal */}
          {showModal && (modalType === 'add' || modalType === 'edit') && (
            <div className="modal-backdrop" onClick={closeModal}>
              <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                {/* Header */}
                <div className="p-4 border-b border-slate-700 flex items-center justify-between">
                  <h2 className="text-xl font-bold">
                    {modalType === 'add' ? 'âž• Add' : 'âœï¸ Edit'} Session
                  </h2>
                  <button onClick={closeModal} className="text-slate-400 hover:text-white text-2xl">Ã—</button>
                </div>

                {/* Form */}
                <div className="p-4 space-y-4">
                  {/* Session Type */}
                  <div>
                    <label className="block text-sm font-semibold text-slate-400 mb-2">Session Type *</label>
                    <select 
                      id="modalSessionType" 
                      className="input-field" 
                      value={currentSessionType}
                      onChange={(e) => handleSessionTypeChange(e.target.value)}
                    >
                      <option value="Easy Run">Easy Run</option>
                      <option value="Long Run">Long Run</option>
                      <option value="Tempo Run">Tempo Run</option>
                      <option value="Speed Intervals">Speed Intervals</option>
                      <option value="Recovery Run">Recovery Run</option>
                      <option value="Futsal">Futsal</option>
                      <option value="Pedicab">Pedicab</option>
                      <option value="Strength Training">Strength Training</option>
                      <option value="Cross-Training">Cross-Training</option>
                    </select>
                  </div>

                  {/* Date & Phase */}
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className="block text-sm font-semibold text-slate-400 mb-2">Date *</label>
                      <input
                        type="date"
                        className="input-field"
                        value={formData.date || new Date().toISOString().split('T')[0]}
                        onChange={(e) => handleFormChange('date', e.target.value)}
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-semibold text-slate-400 mb-2">Phase *</label>
                      <select 
                        className="input-field" 
                        value={formData.phase || 'Base'}
                        onChange={(e) => handleFormChange('phase', e.target.value)}
                      >
                        <option value="Base">Base</option>
                        <option value="Build">Build</option>
                        <option value="Specialty">Specialty</option>
                        <option value="Taper">Taper</option>
                      </select>
                    </div>
                  </div>

                  {/* FUTSAL SPECIFIC SECTION */}
                  {currentSessionType === 'Futsal' && (
                    <div className="space-y-3">
                      {/* Intensity Badge */}
                      <div className="intensity-badge intensity-high">
                        <span className="icon">âš½</span>
                        <span>HIGH INTENSITY SESSION</span>
                      </div>

                      {/* Auto-fill Info */}
                      <div className="auto-fill-info" style={{ background: 'linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(244, 63, 94, 0.15))', border: '2px solid rgba(139, 92, 246, 0.3)' }}>
                        <span className="icon">âœ¨</span>
                        <div>
                          <div className="font-semibold text-purple-300 mb-1">Auto-Filled Values</div>
                          <div className="text-xs text-purple-200 space-y-1">
                            <div>â€¢ Duration: 60 minutes (Tue fixed constraint)</div>
                            <div>â€¢ Avg HR: 165 bpm | Max HR: 185 bpm</div>
                            <div>â€¢ RPE: 8/10 (Z4-Z5 intensity)</div>
                            <div>â€¢ Intensity Factor: 1.05</div>
                          </div>
                        </div>
                      </div>

                      {/* Editable Fields */}
                      <div className="grid grid-cols-2 gap-3">
                        <div>
                          <label className="block text-sm font-semibold text-slate-400 mb-2">Duration (min)</label>
                          <input
                            type="number"
                            className="input-field"
                            value={formData.duration || 60}
                            onChange={(e) => handleFormChange('duration', e.target.value)}
                            min="0"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-semibold text-slate-400 mb-2">RPE (1-10)</label>
                          <input
                            type="number"
                            className="input-field"
                            value={formData.rpe || 8}
                            onChange={(e) => handleFormChange('rpe', e.target.value)}
                            min="1"
                            max="10"
                          />
                        </div>
                      </div>

                      <div className="grid grid-cols-2 gap-3">
                        <div>
                          <label className="block text-sm font-semibold text-slate-400 mb-2">Avg HR (bpm)</label>
                          <input
                            type="number"
                            className="input-field"
                            value={formData.avgHr || 165}
                            onChange={(e) => handleFormChange('avgHr', e.target.value)}
                            min="0"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-semibold text-slate-400 mb-2">Max HR (bpm)</label>
                          <input
                            type="number"
                            className="input-field"
                            value={formData.maxHr || 185}
                            onChange={(e) => handleFormChange('maxHr', e.target.value)}
                            min="0"
                          />
                        </div>
                      </div>
                    </div>
                  )}

                  {/* PEDICAB SPECIFIC SECTION */}
                  {currentSessionType === 'Pedicab' && (
                    <div className="space-y-3">
                      {/* Intensity Badge */}
                      <div className="intensity-badge intensity-moderate">
                        <span className="icon">ðŸš´</span>
                        <span>CROSS-TRAINING ENDURANCE</span>
                      </div>

                      {/* Auto-fill Info */}
                      <div className="auto-fill-info" style={{ background: 'linear-gradient(135deg, rgba(6, 182, 212, 0.15), rgba(16, 185, 129, 0.15))', border: '2px solid rgba(6, 182, 212, 0.3)' }}>
                        <span className="icon">âœ¨</span>
                        <div>
                          <div className="font-semibold text-cyan-300 mb-1">Auto-Filled Values</div>
                          <div className="text-xs text-cyan-200 space-y-1">
                            <div>â€¢ Duration: 6 hours (Sat shifts)</div>
                            <div>â€¢ Avg HR: 120 bpm | Max HR: 145 bpm</div>
                            <div>â€¢ RPE: 5/10 (Z2-Z3 intensity)</div>
                            <div>â€¢ Intensity Factor: 0.65</div>
                            <div>â€¢ TSS varies by route type (flat/hilly)</div>
                          </div>
                        </div>
                      </div>

                      {/* Hours Input */}
                      <div>
                        <label className="block text-sm font-semibold text-slate-400 mb-2">Hours Worked *</label>
                        <input
                          type="number"
                          id="modalPedicabHours"
                          className="input-field"
                          value={(formData.duration || 360) / 60}
                          onChange={(e) => handleFormChange('duration', e.target.value * 60)}
                          placeholder="6"
                          step="0.5"
                          min="0"
                        />
                      </div>

                      {/* Route Type */}
                      <div>
                        <label className="block text-sm font-semibold text-slate-400 mb-2">Route Type</label>
                        <select
                          className="input-field"
                          value={formData.routeType || 'flat'}
                          onChange={(e) => handleFormChange('routeType', e.target.value)}
                        >
                          <option value="flat">Flat (1.0x multiplier)</option>
                          <option value="hilly">Hilly (1.3x multiplier)</option>
                        </select>
                      </div>

                      {/* Editable Fields */}
                      <div className="grid grid-cols-2 gap-3">
                        <div>
                          <label className="block text-sm font-semibold text-slate-400 mb-2">RPE (1-10)</label>
                          <input
                            type="number"
                            className="input-field"
                            value={formData.rpe || 5}
                            onChange={(e) => handleFormChange('rpe', e.target.value)}
                            min="1"
                            max="10"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-semibold text-slate-400 mb-2">Avg HR (bpm)</label>
                          <input
                            type="number"
                            className="input-field"
                            value={formData.avgHr || 120}
                            onChange={(e) => handleFormChange('avgHr', e.target.value)}
                            min="0"
                          />
                        </div>
                      </div>
                    </div>
                  )}

                  {/* RUNNING FIELDS (for non-special sessions) */}
                  {currentSessionType !== 'Pedicab' && currentSessionType !== 'Futsal' && (
                    <>
                      <div className="grid grid-cols-2 gap-3">
                        <div>
                          <label className="block text-sm font-semibold text-slate-400 mb-2">Distance (km)</label>
                          <input
                            type="number"
                            className="input-field"
                            value={formData.distance || ''}
                            onChange={(e) => handleFormChange('distance', e.target.value)}
                            placeholder="10.5"
                            step="0.1"
                            min="0"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-semibold text-slate-400 mb-2">Duration (min)</label>
                          <input
                            type="number"
                            className="input-field"
                            value={formData.duration || ''}
                            onChange={(e) => handleFormChange('duration', e.target.value)}
                            placeholder="66"
                            min="0"
                          />
                        </div>
                      </div>

                      <div className="grid grid-cols-2 gap-3">
                        <div>
                          <label className="block text-sm font-semibold text-slate-400 mb-2">Avg Pace (MM:SS)</label>
                          <input
                            type="text"
                            className="input-field"
                            value={paceInputs.avgPace}
                            onChange={(e) => {
                              // Just update the raw input, don't format yet
                              setPaceInputs(prev => ({ ...prev, avgPace: e.target.value }));
                            }}
                            onBlur={(e) => {
                              // On blur, convert to seconds and update formData
                              const inputValue = e.target.value;
                              if (inputValue.includes(':')) {
                                const paceSeconds = paceToSeconds(inputValue);
                                if (paceSeconds !== null && paceSeconds > 0) {
                                  handleFormChange('avgPace', paceSeconds);
                                  // Format it properly
                                  setPaceInputs(prev => ({ ...prev, avgPace: formatPace(paceSeconds) }));
                                } else {
                                  // Invalid, clear it
                                  handleFormChange('avgPace', null);
                                  setPaceInputs(prev => ({ ...prev, avgPace: '' }));
                                }
                              } else if (!inputValue) {
                                // Empty, clear it
                                handleFormChange('avgPace', null);
                              }
                            }}
                            placeholder="6:30"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-semibold text-slate-400 mb-2">RPE (1-10)</label>
                          <input
                            type="number"
                            className="input-field"
                            value={formData.rpe || ''}
                            onChange={(e) => handleFormChange('rpe', e.target.value)}
                            placeholder="7"
                            min="1"
                            max="10"
                          />
                        </div>
                      </div>

                      <div className="grid grid-cols-2 gap-3">
                        <div>
                          <label className="block text-sm font-semibold text-slate-400 mb-2">Avg HR (bpm)</label>
                          <input
                            type="number"
                            className="input-field"
                            value={formData.avgHr || ''}
                            onChange={(e) => handleFormChange('avgHr', e.target.value)}
                            placeholder="142"
                            min="0"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-semibold text-slate-400 mb-2">Max HR (bpm)</label>
                          <input
                            type="number"
                            className="input-field"
                            value={formData.maxHr || ''}
                            onChange={(e) => handleFormChange('maxHr', e.target.value)}
                            placeholder="165"
                            min="0"
                          />
                        </div>
                      </div>

                      {/* Zone Data */}
                      <div className="card p-3 bg-blue-900/10 border-blue-700/30 space-y-3">
                        <h4 className="text-sm font-semibold text-blue-300">Zone & Performance Data (Optional)</h4>
                        <div className="grid grid-cols-2 gap-3">
                          <div>
                            <label className="block text-xs text-slate-400 mb-1">Avg Z2 Pace (MM:SS)</label>
                            <input
                              type="text"
                              className="input-field"
                              value={paceInputs.z2Pace}
                              onChange={(e) => {
                                // Just update the raw input, don't format yet
                                setPaceInputs(prev => ({ ...prev, z2Pace: e.target.value }));
                              }}
                              onBlur={(e) => {
                                // On blur, convert to seconds and update formData
                                const inputValue = e.target.value;
                                if (inputValue.includes(':')) {
                                  const paceSeconds = paceToSeconds(inputValue);
                                  if (paceSeconds !== null && paceSeconds > 0) {
                                    handleFormChange('z2Pace', paceSeconds);
                                    // Format it properly
                                    setPaceInputs(prev => ({ ...prev, z2Pace: formatPace(paceSeconds) }));
                                  } else {
                                    // Invalid, clear it
                                    handleFormChange('z2Pace', null);
                                    setPaceInputs(prev => ({ ...prev, z2Pace: '' }));
                                  }
                                } else if (!inputValue) {
                                  // Empty, clear it
                                  handleFormChange('z2Pace', null);
                                }
                              }}
                              placeholder="6:30"
                            />
                          </div>
                          <div>
                            <label className="block text-xs text-slate-400 mb-1">Time in Z2 (min)</label>
                            <input
                              type="number"
                              className="input-field"
                              value={formData.z2Time || ''}
                              onChange={(e) => handleFormChange('z2Time', e.target.value)}
                              placeholder="40"
                              min="0"
                            />
                          </div>
                        </div>
                        <div>
                          <label className="block text-xs text-slate-400 mb-1">Avg Cadence (spm)</label>
                          <input
                            type="number"
                            className="input-field"
                            value={formData.avgCadence || ''}
                            onChange={(e) => handleFormChange('avgCadence', e.target.value)}
                            placeholder="168"
                            min="140"
                            max="200"
                          />
                        </div>
                      </div>
                    </>
                  )}

                  {/* Calculated TSS Display */}
                  {calculatedTSS > 0 && (
                    <div className="tss-display">
                      <div>
                        <div className="text-xs text-purple-300 font-semibold">Estimated TSS</div>
                        <div className="text-xs text-slate-400">Training Stress Score</div>
                      </div>
                      <div className="tss-value">{calculatedTSS}</div>
                    </div>
                  )}

                  {/* Notes */}
                  <div>
                    <label className="block text-sm font-semibold text-slate-400 mb-2">Notes</label>
                    <textarea
                      id="modalNotes"
                      className="input-field"
                      placeholder="How did the session feel?"
                      rows="3"
                      value={formData.notes || ''}
                      onChange={(e) => handleFormChange('notes', e.target.value)}
                    ></textarea>
                  </div>
                </div>

                {/* Footer */}
                <div className="p-4 border-t border-slate-700 flex gap-2">
                  <button className="btn btn-primary flex-1" onClick={handleSaveSession}>
                    {modalType === 'add' ? 'Add Session' : 'Save Changes'}
                  </button>
                  <button className="btn btn-secondary" onClick={closeModal}>Cancel</button>
                </div>
              </div>
            </div>
          )}

          <BottomNav currentPage="history" />
        </div>
      );
    }

    ReactDOM.render(<TrainingHistory />, document.getElementById('root'));
  </script>
</body>
</html>
