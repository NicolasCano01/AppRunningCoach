<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="Running Coach Pro - AI Smart Coach">
  <meta name="theme-color" content="#0ea5e9">
  <title>Running Coach Pro - Smart Coach</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700;9..40,800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <style>
    :root {
      --bg-primary: #0a0f1a;
      --bg-secondary: #111827;
      --bg-card: #1a2332;
      --bg-elevated: #243044;
      --accent-blue: #3b82f6;
      --accent-cyan: #06b6d4;
      --accent-emerald: #10b981;
      --accent-amber: #f59e0b;
      --accent-rose: #f43f5e;
      --accent-purple: #8b5cf6;
      --text-primary: #f8fafc;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --border-color: #334155;
    }
    
    * { 
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      box-sizing: border-box;
    }
    
    .mono { font-family: 'Space Mono', monospace; }
    
    body {
      background: linear-gradient(135deg, var(--bg-primary) 0%, #0f172a 50%, #1e1b4b 100%);
      min-height: 100vh;
      color: var(--text-primary);
      margin: 0;
      padding: 0;
    }
    
    .top-nav {
      background: rgba(26, 35, 50, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .nav-link {
      padding: 12px 20px;
      border-radius: 12px;
      transition: all 0.2s ease;
      font-weight: 500;
      text-decoration: none;
      display: inline-block;
      color: var(--text-primary);
    }
    
    .nav-link:hover {
      background: rgba(59, 130, 246, 0.2);
    }
    
    .nav-link.active {
      background: var(--accent-emerald);
      color: white;
    }
    
    .main-content {
      padding: 20px;
    }
    
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-secondary); border-radius: 4px; }
    ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #475569; }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: scale(0.95) translateY(-10px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .fade-in { animation: fadeIn 0.4s ease-out forwards; }
    .slide-in { animation: slideIn 0.3s ease-out forwards; }
    
    .spinner {
      border: 3px solid rgba(59, 130, 246, 0.2);
      border-top: 3px solid var(--accent-blue);
      border-radius: 50%;
      width: 48px;
      height: 48px;
      animation: spin 0.8s cubic-bezier(0.4, 0, 0.2, 1) infinite;
    }
    
    .glass {
      background: rgba(26, 35, 50, 0.85);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      transition: all 0.3s ease;
    }
    
    .card:hover {
      border-color: rgba(59, 130, 246, 0.3);
    }
    
    .input-field {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 10px 14px;
      color: var(--text-primary);
      width: 100%;
      transition: all 0.2s ease;
      font-size: 14px;
    }
    
    .input-field:focus {
      outline: none;
      border-color: var(--accent-blue);
      background: var(--bg-elevated);
    }
    
    .input-field::placeholder {
      color: var(--text-muted);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--accent-blue) 0%, #2563eb 100%);
      color: white;
      font-weight: 600;
      padding: 12px 24px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
    }
    
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-secondary {
      background: var(--bg-elevated);
      color: var(--text-primary);
      font-weight: 500;
      padding: 10px 20px;
      border-radius: 10px;
      border: 1px solid var(--border-color);
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-secondary:hover {
      background: #2d3a4f;
      border-color: rgba(255, 255, 255, 0.2);
    }
    
    .btn-success {
      background: linear-gradient(135deg, var(--accent-emerald) 0%, #059669 100%);
      color: white;
      font-weight: 600;
      padding: 10px 20px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
      animation: fadeIn 0.2s ease-out;
    }
    
    .modal-content {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      animation: slideIn 0.3s ease-out;
    }
    
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 14px 20px;
      border-radius: 12px;
      font-weight: 500;
      z-index: 9999;
      animation: slideIn 0.3s ease-out;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }
    
    .toast-success {
      background: linear-gradient(135deg, var(--accent-emerald) 0%, #059669 100%);
      color: white;
    }
    
    .toast-error {
      background: linear-gradient(135deg, var(--accent-rose) 0%, #dc2626 100%);
      color: white;
    }
    
    .settings-bar {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 24px;
    }
    
    .settings-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      background: rgba(59, 130, 246, 0.05);
      border-radius: 8px;
    }
    
    .gradient-text {
      background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 50%, #f0abfc 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .badge-immovable {
      background: rgba(245, 158, 11, 0.2);
      color: var(--accent-amber);
    }
    
    @media (max-width: 768px) {
      .main-content {
        padding: 12px;
      }
      
      .modal-content {
        margin: 10px;
        max-height: 95vh;
      }
    }
  </style>
</head>

<body>
  <nav class="top-nav">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="index.html" class="flex items-center gap-2 text-xl font-bold">
        <i data-lucide="activity" class="w-6 h-6 text-emerald-400"></i>
        <span class="hidden sm:inline">RCP</span>
      </a>
      
      <div class="flex items-center gap-2">
        <a href="AnalyticsPanel.html" class="nav-link">Analytics</a>
        <a href="HistoryPanel.html" class="nav-link">History</a>
        <a href="SmartCoachPanel.html" class="nav-link active">Smart Coach</a>
      </div>
    </div>
  </nav>

  <div class="main-content">
    <div id="app"></div>
  </div>

  <script>
    // ==================== FIREBASE CONFIG ====================
    const firebaseConfig = {
      apiKey: "AIzaSyCQr84Yu0lTkKMnqtgYDD5NP4i_n5qS4eM",
      authDomain: "runningcoachdata.firebaseapp.com",
      projectId: "runningcoachdata",
      storageBucket: "runningcoachdata.firebasestorage.app",
      messagingSenderId: "364279562892",
      appId: "1:364279562892:web:7acd6bbac8c8113177f1a9"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }

    const auth = firebase.auth();
    const db = firebase.firestore();
    let settingsRef = null;
    let currentUser = null;

    // ==================== AUTH ====================
    function waitForAuth() {
      return new Promise((resolve, reject) => {
        const unsubscribe = auth.onAuthStateChanged((user) => {
          if (user) {
            console.log('‚úÖ User authenticated:', user.email);
            currentUser = user;
            settingsRef = db.collection('users').doc(user.uid).collection('settings');
            unsubscribe();
            resolve(user);
          } else {
            console.log('üîë Attempting sign-in...');
            auth.signInWithEmailAndPassword('nic@runningcoach.com', 'policias')
              .then(userCredential => {
                currentUser = userCredential.user;
                settingsRef = db.collection('users').doc(userCredential.user.uid).collection('settings');
                unsubscribe();
                resolve(userCredential.user);
              })
              .catch(error => {
                console.error('‚ùå Auth failed:', error);
                unsubscribe();
                reject(error);
              });
          }
        });
      });
    }

    // ==================== HELPERS ====================
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `
        <i data-lucide="${type === 'success' ? 'check-circle' : 'alert-circle'}"></i>
        ${message}
      `;
      document.body.appendChild(toast);
      lucide.createIcons();
      
      setTimeout(() => {
        toast.style.animation = 'fadeIn 0.3s ease-out reverse';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
    
    function parsePace(paceString) {
	  if (!paceString) return null;
	  const parts = paceString.split(':');
	  if (parts.length === 2) {
	    const mins = parseInt(parts[0]);
	    const secs = parseInt(parts[1]);
	    return mins * 60 + secs;
	  }
	  return null;
	}
	
	function formatPace(secondsPerKm) {
	  if (!secondsPerKm) return '';
	  const mins = Math.floor(secondsPerKm / 60);
	  const secs = secondsPerKm % 60;
	  return `${mins}:${String(secs).padStart(2, '0')}`;
	}

// ==================== SMART COACH PANEL ====================

    // ==================== SMART COACH PANEL ====================
    class SmartCoachPanel {

      constructor() {
        this.settings = null;
        this.loading = true;
        this.showSettingsModal = false;
        this.editingSettings = null;
        this.init();
      }
      
      async init() {
        console.log('üöÄ Smart Coach initializing...');
        this.render();
        
        try {
          await waitForAuth();
          await this.loadSettings();
          console.log('‚úÖ Initialization complete');
        } catch (error) {
          console.error('‚ùå Init error:', error);
          showToast('Error initializing', 'error');
          this.loading = false;
          this.render();
        }
        
        lucide.createIcons();
      }
      
      async loadSettings() {
        this.loading = true;
        this.render();
        
        try {
          const doc = await settingsRef.doc('settings').get();
          
          if (doc.exists) {
            this.settings = { id: doc.id, ...doc.data() };
            console.log('‚úÖ Settings loaded');
          } else {
            this.settings = null;
            console.log('‚ö†Ô∏è No settings - showing onboarding');
          }
          
          this.loading = false;
          this.render();
        } catch (error) {
          console.error('‚ùå Load error:', error);
          showToast('Error loading settings', 'error');
          this.loading = false;
          this.render();
        }
      }
      
      async saveSettings(settingsData) {
        try {
          console.log('üíæ Saving...');
          
          const toSave = {
            ...settingsData,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          };
          
          await settingsRef.doc('settings').set(toSave, { merge: true });
          console.log('‚úÖ Saved');
          showToast('Settings saved');
          
          await this.loadSettings();
          this.closeSettingsModal();
        } catch (error) {
          console.error('‚ùå Save error:', error);
          showToast('Error saving', 'error');
        }
      }
      
      openSettingsModal() {
		  // Merge existing settings with defaults to ensure all fields exist
		  const defaults = this.getDefaultSettings();
		  this.editingSettings = this.settings ? { 
			...defaults,           // Start with complete defaults
			...this.settings,      // Override with saved settings
			// Ensure nested objects are properly merged
			easyPaceRange: this.settings.easyPaceRange || defaults.easyPaceRange,
			fixedActivities: this.settings.fixedActivities || defaults.fixedActivities
		  } : defaults;
		  
		  this.showSettingsModal = true;
		  this.editingFixedActivities = { ...this.editingSettings.fixedActivities };
		  this.render();
		  setTimeout(() => {
			this.renderFixedActivitiesList();
		  }, 10);
		}
      
      closeSettingsModal() {
        this.showSettingsModal = false;
        this.editingSettings = null;
        this.render();
        lucide.createIcons();
      }
      
      getDefaultSettings() {
        return {
          goalDistance: 'Marathon',
          targetTime: '3:25:00',
          targetRaceDate: null,
          currentPhase: 'Base',
          availableDays: ['Monday', 'Wednesday', 'Thursday', 'Sunday'],
          fixedActivities: {
            Tuesday: { type: 'Futsal', priority: 'immovable', defaults: { distance: 8, duration: 60, tss: 95 } },
            Saturday: { type: 'Pedicab', priority: 'immovable', defaults: { distance: 18, duration: 360, tss: 72 } },
            Friday: { type: 'Rest', priority: 'immovable' }
          },
          preferredLongRunDay: 'Monday',
          preferredRestDay: 'Friday',
          lthr: 165,
          maxHr: 188,
          easyPaceRange: { min: 380, max: 400 },
          activeInjuries: [
            { location: 'left_calf', status: 'monitor', since: '2025-11-01', notes: 'Occasional tightness' }
          ],
          maxWeeklyVolumeKm: 60,
          volumeProgressionLimit: 10,
          week1StartDate: '2025-11-10',
          autoApprovePlans: false
        };
      }
      
      handleSaveSettings() {
        try {
          const availableDays = [];
          document.querySelectorAll('.available-day:checked').forEach(cb => availableDays.push(cb.value));
          
          const injuryLocation = document.getElementById('injuryLocation').value;
          const injurySince = document.getElementById('injurySince').value;
          
          const settingsData = {
			  goalDistance: document.getElementById('goalDistance').value,
			  targetTime: document.getElementById('targetTime').value,
			  targetRaceDate: document.getElementById('targetRaceDate').value || null,
			  currentPhase: document.getElementById('currentPhase').value,
			  availableDays: availableDays,
			  fixedActivities: this.editingFixedActivities || {}, // ‚úÖ Default to empty object
			  preferredLongRunDay: document.getElementById('preferredLongRunDay').value,
			preferredRestDay: document.getElementById('preferredRestDay').value,
			lthr: parseInt(document.getElementById('lthr').value) || 165,
			maxHr: parseInt(document.getElementById('maxHr').value) || 188,
			easyPaceRange: {
			  min: parsePace(document.getElementById('easyPaceMin').value) || 380,
			  max: parsePace(document.getElementById('easyPaceMax').value) || 400
			}, 
            activeInjuries: injuryLocation ? [{
              location: injuryLocation.toLowerCase().replace(/ /g, '_'),
              status: 'monitor',
              since: injurySince || new Date().toISOString().split('T')[0],
              notes: injuryLocation
            }] : [],
            maxWeeklyVolumeKm: this.editingSettings.maxWeeklyVolumeKm || 60,
            volumeProgressionLimit: this.editingSettings.volumeProgressionLimit || 10,
            week1StartDate: this.editingSettings.week1StartDate || '2025-11-10',
            autoApprovePlans: this.editingSettings.autoApprovePlans || false
          };
          
          this.saveSettings(settingsData);
        } catch (error) {
          console.error('‚ùå Gather error:', error);
          showToast('Error saving', 'error');
        }
      }
	  
	  addFixedActivity() {
		  const day = prompt('Which day? (e.g., Tuesday, Saturday)');
		  if (!day) return;
		  
		  const activity = prompt('Activity name? (e.g., Futsal, Pedicab, Rest)');
		  if (!activity) return;
		  
		  if (!this.editingFixedActivities) {
			this.editingFixedActivities = {};
		  }
		  
		  this.editingFixedActivities[day] = {
			type: activity,
			priority: 'immovable',
			defaults: { distance: 0, duration: 60, tss: 0 }
		  };
		  
		  this.renderFixedActivitiesList();
		}

		removeFixedActivity(day) {
		  if (confirm(`Remove ${day} activity?`)) {
			delete this.editingFixedActivities[day];
			this.renderFixedActivitiesList();
		  }
		}

		renderFixedActivitiesList() {
		  const container = document.getElementById('fixedActivitiesList');
		  if (!container) return;
		  
		  const activities = this.editingFixedActivities || {};
		  
		  if (Object.keys(activities).length === 0) {
			container.innerHTML = '<p style="color: #64748b; font-style: italic;">No fixed activities yet</p>';
		  } else {
			container.innerHTML = Object.keys(activities).map(day => {
			  const activity = activities[day];
			  return `
				<div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(245, 158, 11, 0.05); border-radius: 8px;">
				  <span style="width: 100px; font-weight: 600;">${day}:</span>
				  <span style="flex: 1; color: #f59e0b;">${activity.type}</span>
				  <span class="badge badge-immovable">Immovable</span>
				  <button onclick="app.removeFixedActivity('${day}')" style="color: #f43f5e; background: none; border: none; cursor: pointer; padding: 4px;">
					<i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
				  </button>
				</div>
			  `;
			}).join('');
		  }
		  
		  lucide.createIcons();
		}
      
      render() {
        const app = document.getElementById('app');
        if (!app) return;
        
        try {
          let html = this.loading ? this.renderLoading() : 
                     !this.settings ? this.renderOnboarding() : 
                     this.renderMainContent();
          
          if (this.showSettingsModal) html += this.renderSettingsModal();
          
          app.innerHTML = html;
          lucide.createIcons();
        } catch (error) {
          console.error('‚ùå Render error:', error);
          app.innerHTML = '<div style="color: #f43f5e; padding: 40px; text-align: center;">Error rendering. Check console.</div>';
        }
      }
      
      renderLoading() {
        return `
          <div style="display: flex; align-items: center; justify-content: center; height: 70vh;">
            <div style="text-align: center;">
              <div class="spinner" style="margin: 0 auto 16px;"></div>
              <p style="color: #94a3b8;">Loading Smart Coach...</p>
            </div>
          </div>
        `;
      }
      
      renderOnboarding() {
        return `
          <div style="max-width: 600px; margin: 48px auto;">
            <div class="card" style="padding: 48px; text-align: center;">
              <div style="margin-bottom: 24px;">
                <div style="width: 80px; height: 80px; margin: 0 auto 16px; border-radius: 50%; background: rgba(59, 130, 246, 0.1); display: flex; align-items: center; justify-content: center;">
                  <i data-lucide="settings" style="width: 40px; height: 40px; color: #3b82f6;"></i>
                </div>
                <h2 style="font-size: 28px; font-weight: bold; margin-bottom: 12px;">Welcome to Smart Coach!</h2>
                <p style="color: #94a3b8; font-size: 16px;">
                  Let's set up your training preferences to get started with AI-powered coaching
                </p>
              </div>
              
              <button onclick="app.openSettingsModal()" class="btn-primary" style="font-size: 16px;">
                <i data-lucide="play"></i>
                Set Up Training Settings
              </button>
            </div>
          </div>
        `;
      }
      
      renderMainContent() {
        const s = this.settings;
        const fixedDays = Object.keys(s.fixedActivities || {}).map(day => 
          `${day} (${s.fixedActivities[day].type})`
        ).join(', ');
        
        const injury = s.activeInjuries && s.activeInjuries.length > 0 
          ? s.activeInjuries[0].location.replace('_', ' ')
          : 'None';
        
        return `
          <div class="max-w-7xl mx-auto">
            <div class="mb-8 fade-in">
              <h1 class="text-4xl font-bold gradient-text flex items-center gap-3 mb-2">
                <i data-lucide="brain"></i>
                AI Smart Coach
              </h1>
              <p style="color: #94a3b8;">Intelligent training planning powered by AI</p>
            </div>
            
            <div class="settings-bar fade-in">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; flex-wrap: wrap;">
                <div style="flex: 1; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                  <div class="settings-item">
                    <i data-lucide="target" style="width: 20px; height: 20px; color: #3b82f6;"></i>
                    <div style="font-size: 14px; color: #94a3b8;">
                      Goal: <span style="font-weight: 600; color: #f8fafc;">${s.goalDistance} ${s.targetTime}</span>
                    </div>
                  </div>
                  
                  <div class="settings-item">
                    <i data-lucide="calendar" style="width: 20px; height: 20px; color: #3b82f6;"></i>
                    <div style="font-size: 14px; color: #94a3b8;">
                      Phase: <span style="font-weight: 600; color: #f8fafc;">${s.currentPhase}</span>
                    </div>
                  </div>
                  
                  <div class="settings-item">
                    <i data-lucide="calendar-check" style="width: 20px; height: 20px; color: #3b82f6;"></i>
                    <div style="font-size: 14px; color: #94a3b8;">
                      Available: <span style="font-weight: 600; color: #f8fafc;">${s.availableDays ? s.availableDays.length : 0} days</span>
                    </div>
                  </div>
                  
                  <div class="settings-item">
                    <i data-lucide="lock" style="width: 20px; height: 20px; color: #3b82f6;"></i>
                    <div style="font-size: 14px; color: #94a3b8;">
                      Fixed: <span style="font-weight: 600; color: #f8fafc;">${fixedDays || 'None'}</span>
                    </div>
                  </div>
                  
                  <div class="settings-item">
                    <i data-lucide="activity" style="width: 20px; height: 20px; color: #3b82f6;"></i>
                    <div style="font-size: 14px; color: #94a3b8;">
                      LTHR: <span style="font-weight: 600; color: #f8fafc;">${s.lthr} bpm</span>
                    </div>
                  </div>
                  
                  <div class="settings-item">
                    <i data-lucide="alert-circle" style="width: 20px; height: 20px; color: #3b82f6;"></i>
                    <div style="font-size: 14px; color: #94a3b8;">
                      Injury: <span style="font-weight: 600; color: #f8fafc;">${injury}</span>
                    </div>
                  </div>
                </div>
                
                <button onclick="app.openSettingsModal()" class="btn-secondary" style="flex-shrink: 0;">
                  <i data-lucide="settings"></i>
                  Edit Settings
                </button>
              </div>
            </div>
            
            <div class="card" style="padding: 48px; text-align: center;">
              <i data-lucide="calendar-plus" style="width: 64px; height: 64px; margin: 0 auto 16px; color: #3b82f6;"></i>
              <h2 style="font-size: 24px; font-weight: bold; margin-bottom: 8px;">Ready to Generate Your Plan</h2>
              <p style="color: #94a3b8; margin-bottom: 24px;">AI-powered weekly training plans coming in Sprint 2</p>
              <button class="btn-primary" disabled style="opacity: 0.5; cursor: not-allowed;">
                <i data-lucide="sparkles"></i>
                Generate Next Week's Plan
                <span style="font-size: 12px; opacity: 0.7;">(Coming Soon)</span>
              </button>
            </div>
          </div>
        `;
      }
      
      renderSettingsModal() {
 		 const s = this.editingSettings;
 		 
 		 // Pre-calculate pace values to avoid scope issues
 		 const easyPaceMinDisplay = formatPace(s.easyPaceRange?.min || 380);
 		 const easyPaceMaxDisplay = formatPace(s.easyPaceRange?.max || 400);
 		 
 		 const settingsFormHTML = `

          <!-- Goal -->
          <div style="margin-bottom: 24px;">
            <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
              <i data-lucide="target" style="width: 20px; height: 20px; color: #3b82f6;"></i>
              Goal
            </h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
              <div>
                <label style="display: block; font-size: 14px; color: #94a3b8; margin-bottom: 8px;">Distance</label>
                <select id="goalDistance" class="input-field">
                  <option value="5K">5K</option>
                  <option value="10K">10K</option>
                  <option value="Half">Half Marathon</option>
                  <option value="Marathon" selected>Marathon</option>
                </select>
              </div>
              <div>
                <label style="display: block; font-size: 14px; color: #94a3b8; margin-bottom: 8px;">Target Time</label>
                <input type="text" id="targetTime" class="input-field" value="${s.targetTime || ''}" placeholder="3:25:00">
              </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-top: 16px;">
              <div>
                <label style="display: block; font-size: 14px; color: #94a3b8; margin-bottom: 8px;">Race Date (optional)</label>
                <input type="date" id="targetRaceDate" class="input-field" value="${s.targetRaceDate || ''}">
              </div>
              <div>
                <label style="display: block; font-size: 14px; color: #94a3b8; margin-bottom: 8px;">Current Phase</label>
                <select id="currentPhase" class="input-field">
                  <option value="Base" selected>Base</option>
                  <option value="Build">Build</option>
                  <option value="Specialty">Specialty</option>
                  <option value="Taper">Taper</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- Availability -->
          <div style="margin-bottom: 24px;">
            <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
              <i data-lucide="calendar-check" style="width: 20px; height: 20px; color: #3b82f6;"></i>
              Availability
            </h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" class="available-day" value="Monday" ${s.availableDays && s.availableDays.includes('Monday') ? 'checked' : ''} style="width: 20px; height: 20px; accent-color: #3b82f6;">
                <span>Monday</span>
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" class="available-day" value="Tuesday" ${s.availableDays && s.availableDays.includes('Tuesday') ? 'checked' : ''} style="width: 20px; height: 20px; accent-color: #3b82f6;">
                <span>Tuesday</span>
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" class="available-day" value="Wednesday" ${s.availableDays && s.availableDays.includes('Wednesday') ? 'checked' : ''} style="width: 20px; height: 20px; accent-color: #3b82f6;">
                <span>Wednesday</span>
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" class="available-day" value="Thursday" ${s.availableDays && s.availableDays.includes('Thursday') ? 'checked' : ''} style="width: 20px; height: 20px; accent-color: #3b82f6;">
                <span>Thursday</span>
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" class="available-day" value="Friday" ${s.availableDays && s.availableDays.includes('Friday') ? 'checked' : ''} style="width: 20px; height: 20px; accent-color: #3b82f6;">
                <span>Friday</span>
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" class="available-day" value="Saturday" ${s.availableDays && s.availableDays.includes('Saturday') ? 'checked' : ''} style="width: 20px; height: 20px; accent-color: #3b82f6;">
                <span>Saturday</span>
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" class="available-day" value="Sunday" ${s.availableDays && s.availableDays.includes('Sunday') ? 'checked' : ''} style="width: 20px; height: 20px; accent-color: #3b82f6;">
                <span>Sunday</span>
              </label>
            </div>
          </div>
          
          <!-- Fixed Activities -->
			<div style="margin-bottom: 24px;">
			  <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
				<i data-lucide="lock" style="width: 20px; height: 20px; color: #f59e0b;"></i>
				Fixed Activities
			  </h3>
			  <p style="font-size: 14px; color: #94a3b8; margin-bottom: 12px;">Recurring commitments on specific days</p>
			  
			  <div id="fixedActivitiesList" style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 12px;">
				<!-- Will be populated dynamically -->
			  </div>
			  
			  <button onclick="app.addFixedActivity()" class="btn-secondary" style="width: 100%;">
				<i data-lucide="plus"></i>
				Add Fixed Activity
			  </button>
			</div>
          
          <!-- Preferences -->
          <div style="margin-bottom: 24px;">
            <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
              <i data-lucide="star" style="width: 20px; height: 20px; color: #3b82f6;"></i>
              Preferences
            </h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
              <div>
                <label style="display: block; font-size: 14px; color: #94a3b8; margin-bottom: 8px;">Preferred Long Run Day</label>
                <select id="preferredLongRunDay" class="input-field">
                  <option value="Monday" selected>Monday</option>
                  <option value="Tuesday">Tuesday</option>
                  <option value="Wednesday">Wednesday</option>
                  <option value="Thursday">Thursday</option>
                  <option value="Friday">Friday</option>
                  <option value="Saturday">Saturday</option>
                  <option value="Sunday">Sunday</option>
                </select>
              </div>
              <div>
                <label style="display: block; font-size: 14px; color: #94a3b8; margin-bottom: 8px;">Preferred Rest Day</label>
                <select id="preferredRestDay" class="input-field">
                  <option value="Monday">Monday</option>
                  <option value="Tuesday">Tuesday</option>
                  <option value="Wednesday">Wednesday</option>
                  <option value="Thursday">Thursday</option>
                  <option value="Friday" selected>Friday</option>
                  <option value="Saturday">Saturday</option>
                  <option value="Sunday">Sunday</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- Injury -->
          <div style="margin-bottom: 24px;">
            <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
              <i data-lucide="alert-circle" style="width: 20px; height: 20px; color: #f43f5e;"></i>
              Injury Monitoring
            </h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
              <div>
                <label style="display: block; font-size: 14px; color: #94a3b8; margin-bottom: 8px;">Active Injury</label>
                <input type="text" id="injuryLocation" class="input-field" placeholder="e.g., Left calf - monitor" value="${s.activeInjuries && s.activeInjuries.length > 0 ? s.activeInjuries[0].notes : ''}">
              </div>
              <div>
                <label style="display: block; font-size: 14px; color: #94a3b8; margin-bottom: 8px;">Since</label>
                <input type="date" id="injurySince" class="input-field" value="${s.activeInjuries && s.activeInjuries.length > 0 ? s.activeInjuries[0].since : ''}">
              </div>
            </div>
          </div>
          

          <!-- Physiological Data -->
			<div>
			  <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
			    <i data-lucide="activity" style="width: 20px; height: 20px; color: #10b981;"></i>
			    Physiological Data
			  </h3>
			  <p style="font-size: 14px; color: #94a3b8; margin-bottom: 12px;">Auto-pulled from Analytics (editable)</p>
			  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
			    <div>
			      <label style="display: block; font-size: 14px; color: #94a3b8; margin-bottom: 8px;">LTHR (bpm)</label>
			      <input type="number" id="lthr" value="${s.lthr || 165}" class="input-field" placeholder="165">
			    </div>
			    <div>
			      <label style="display: block; font-size: 14px; color: #94a3b8; margin-bottom: 8px;">Max HR (bpm)</label>
			      <input type="number" id="maxHr" value="${s.maxHr || 188}" class="input-field" placeholder="188">
			    </div>
			    <div>
				  <label style="display: block; font-size: 14px; color: #94a3b8; margin-bottom: 8px;">Easy Pace Min (MM:SS)</label>
				  <input type="text" id="easyPaceMin" value="${easyPaceMinDisplay}" class="input-field" placeholder="6:20">
				</div>
				<div>
				  <label style="display: block; font-size: 14px; color: #94a3b8; margin-bottom: 8px;">Easy Pace Max (MM:SS)</label>
				  <input type="text" id="easyPaceMax" value="${easyPaceMaxDisplay}" class="input-field" placeholder="6:40">
				</div>
			  </div>
			</div>
        `;
        
        return `
          <div class="modal-backdrop" onclick="if(event.target === this) app.closeSettingsModal()">
            <div class="modal-content">
              <div style="padding: 24px; border-bottom: 1px solid #334155; display: flex; align-items: center; justify-content: space-between;">
                <h2 style="font-size: 24px; font-weight: bold; display: flex; align-items: center; gap: 8px;">
                  <i data-lucide="settings"></i>
                  Training Settings
                </h2>
                <button onclick="app.closeSettingsModal()" style="color: #94a3b8; cursor: pointer; background: none; border: none; padding: 4px;">
                  <i data-lucide="x" style="width: 24px; height: 24px;"></i>
                </button>
              </div>
              
              <div style="padding: 24px;">
                ${settingsFormHTML}
              </div>
              
              <div style="padding: 24px; border-top: 1px solid #334155; display: flex; justify-content: flex-end; gap: 12px;">
                <button onclick="app.closeSettingsModal()" class="btn-secondary">Cancel</button>
                <button onclick="app.handleSaveSettings()" class="btn-success">
                  <i data-lucide="save"></i>
                  Save Settings
                </button>
              </div>
            </div>
          </div>
        `;
      }
    }
    
    // Initialize
    const app = new SmartCoachPanel();
    window.app = app;
  </script>
</body>
</html>