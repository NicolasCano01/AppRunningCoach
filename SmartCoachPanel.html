<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="Running Coach Pro - AI Smart Coach">
  <meta name="theme-color" content="#0ea5e9">
  <title>Running Coach Pro - Smart Coach</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700;9..40,800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <style>
    :root {
      --bg-primary: #0a0f1a;
      --bg-secondary: #111827;
      --bg-card: #1a2332;
      --bg-elevated: #243044;
      --accent-blue: #3b82f6;
      --accent-cyan: #06b6d4;
      --accent-emerald: #10b981;
      --accent-amber: #f59e0b;
      --accent-rose: #f43f5e;
      --accent-purple: #8b5cf6;
      --text-primary: #f8fafc;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --border-color: #334155;
    }
    
    * { 
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      box-sizing: border-box;
    }
    
    .mono { font-family: 'Space Mono', monospace; }
    
    body {
      background: linear-gradient(135deg, var(--bg-primary) 0%, #0f172a 50%, #1e1b4b 100%);
      min-height: 100vh;
      color: var(--text-primary);
      margin: 0;
      padding: 0;
    }
    
    .top-nav {
      background: rgba(26, 35, 50, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .nav-link {
      padding: 12px 20px;
      border-radius: 12px;
      transition: all 0.2s ease;
      font-weight: 500;
      text-decoration: none;
      display: inline-block;
      color: var(--text-primary);
    }
    
    .nav-link:hover {
      background: rgba(59, 130, 246, 0.2);
    }
    
    .nav-link.active {
      background: var(--accent-emerald);
      color: white;
    }
    
    .main-content {
      padding: 20px;
    }
    
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-secondary); border-radius: 4px; }
    ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #475569; }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: scale(0.95) translateY(-10px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .fade-in { animation: fadeIn 0.4s ease-out forwards; }
    .slide-in { animation: slideIn 0.3s ease-out forwards; }
    
    .spinner {
      border: 3px solid rgba(59, 130, 246, 0.2);
      border-top: 3px solid var(--accent-blue);
      border-radius: 50%;
      width: 48px;
      height: 48px;
      animation: spin 0.8s cubic-bezier(0.4, 0, 0.2, 1) infinite;
    }
    
    .glass {
      background: rgba(26, 35, 50, 0.85);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      transition: all 0.3s ease;
    }
    
    .card:hover {
      border-color: rgba(59, 130, 246, 0.3);
    }
    
    .input-field {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 10px 14px;
      color: var(--text-primary);
      width: 100%;
      transition: all 0.2s ease;
      font-size: 14px;
    }
    
    .input-field:focus {
      outline: none;
      border-color: var(--accent-blue);
      background: var(--bg-elevated);
    }
    
    .input-field::placeholder {
      color: var(--text-muted);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--accent-blue) 0%, #2563eb 100%);
      color: white;
      font-weight: 600;
      padding: 12px 24px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
    }
    
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-secondary {
      background: var(--bg-elevated);
      color: var(--text-primary);
      font-weight: 500;
      padding: 10px 20px;
      border-radius: 10px;
      border: 1px solid var(--border-color);
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-secondary:hover {
      background: #2d3a4f;
      border-color: rgba(255, 255, 255, 0.2);
    }
    
    .btn-success {
      background: linear-gradient(135deg, var(--accent-emerald) 0%, #059669 100%);
      color: white;
      font-weight: 600;
      padding: 10px 20px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
      animation: fadeIn 0.2s ease-out;
    }
    
    .modal-content {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      animation: slideIn 0.3s ease-out;
    }
    
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 14px 20px;
      border-radius: 12px;
      font-weight: 500;
      z-index: 9999;
      animation: slideIn 0.3s ease-out;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }
    
    .toast-success {
      background: linear-gradient(135deg, var(--accent-emerald) 0%, #059669 100%);
      color: white;
    }
    
    .toast-error {
      background: linear-gradient(135deg, var(--accent-rose) 0%, #dc2626 100%);
      color: white;
    }
    
    .settings-bar {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 24px;
    }
    
    .settings-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      background: rgba(59, 130, 246, 0.05);
      border-radius: 8px;
    }
    
    .gradient-text {
      background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 50%, #f0abfc 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .badge-immovable {
      background: rgba(245, 158, 11, 0.2);
      color: var(--accent-amber);
    }
    
    @media (max-width: 768px) {
      .main-content {
        padding: 12px;
      }
      
      .modal-content {
        margin: 10px;
        max-height: 95vh;
      }
    }
  </style>
</head>

<body>
  <nav class="top-nav">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="index.html" class="flex items-center gap-2 text-xl font-bold">
        <i data-lucide="activity" class="w-6 h-6 text-emerald-400"></i>
        <span class="hidden sm:inline">RCP</span>
      </a>
      
      <div class="flex items-center gap-2">
        <a href="AnalyticsPanel.html" class="nav-link">Analytics</a>
        <a href="HistoryPanel.html" class="nav-link">History</a>
        <a href="SmartCoachPanel.html" class="nav-link active">Smart Coach</a>
      </div>
    </div>
  </nav>

  <div class="main-content">
    <div id="app"></div>
  </div>

  <script>
    // ==================== FIREBASE CONFIG ====================
    const firebaseConfig = {
      apiKey: "AIzaSyCQr84Yu0lTkKMnqtgYDD5NP4i_n5qS4eM",
      authDomain: "runningcoachdata.firebaseapp.com",
      projectId: "runningcoachdata",
      storageBucket: "runningcoachdata.firebasestorage.app",
      messagingSenderId: "364279562892",
      appId: "1:364279562892:web:7acd6bbac8c8113177f1a9"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }

    const auth = firebase.auth();
    const db = firebase.firestore();
    let settingsRef = null;
    let currentUser = null;

    // ==================== WEEK CALCULATION HELPERS ====================
    
    const calculateWeekNumber = (anchorDate) => {
      const anchor = new Date(anchorDate);
      const today = new Date();
      const diffTime = today - anchor;
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
      return Math.floor(diffDays / 7) + 1;
    };
    
    const getMesocycleInfo = (weekNumber) => {
      const mesocycleWeek = ((weekNumber - 1) % 4) + 1;
      const mesocycleType = mesocycleWeek === 4 ? 'Discharge' : 'Charge';
      return { mesocycleWeek, mesocycleType };
    };
    
    const getWeekStartDate = (weekNumber, anchorDate) => {
      const anchor = new Date(anchorDate);
      const daysToAdd = (weekNumber - 1) * 7;
      const weekStart = new Date(anchor);
      weekStart.setDate(anchor.getDate() + daysToAdd);
      return weekStart.toISOString().split('T')[0];
    };
    
    
    const parsePaceToSeconds = (paceString) => {
      if (!paceString) return 0;
      const parts = paceString.split(':');
      if (parts.length !== 2) return 0;
      return parseInt(parts[0]) * 60 + parseInt(parts[1]);
    };
    
    // ==================== CTL/ATL/TSB CALCULATION ====================
    
    const calculateCTL = (sessions, currentCTL = 0) => {
      const CTL_TIME_CONSTANT = 42;
      let ctl = currentCTL;
      
      sessions.forEach(session => {
        const tss = session.tss || 0;
        ctl = ctl + (tss - ctl) / CTL_TIME_CONSTANT;
      });
      
      return Math.round(ctl);
    };
    
    const calculateATL = (sessions, currentATL = 0) => {
      const ATL_TIME_CONSTANT = 7;
      let atl = currentATL;
      
      sessions.forEach(session => {
        const tss = session.tss || 0;
        atl = atl + (tss - atl) / ATL_TIME_CONSTANT;
      });
      
      return Math.round(atl);
    };
    
    const calculateTSB = (ctl, atl) => {
      return Math.round(ctl - atl);
    };
    
    const calculatePerformanceMetrics = (sessions) => {
      const ctl = calculateCTL(sessions);
      const atl = calculateATL(sessions);
      const tsb = calculateTSB(ctl, atl);
      
      return { ctl, atl, tsb };
    };

    // ==================== AUTH ====================
    function waitForAuth() {
      return new Promise((resolve, reject) => {
        const unsubscribe = auth.onAuthStateChanged((user) => {
          if (user) {
            console.log('‚úÖ User authenticated:', user.email);
            currentUser = user;
            settingsRef = db.collection('users').doc(user.uid).collection('settings');
            unsubscribe();
            resolve(user);
          } else {
            console.log('üîë Attempting sign-in...');
            auth.signInWithEmailAndPassword('nic@runningcoach.com', 'policias')
              .then(userCredential => {
                currentUser = userCredential.user;
                settingsRef = db.collection('users').doc(userCredential.user.uid).collection('settings');
                unsubscribe();
                resolve(userCredential.user);
              })
              .catch(error => {
                console.error('‚ùå Auth failed:', error);
                unsubscribe();
                reject(error);
              });
          }
        });
      });
    }

    // ==================== HELPERS ====================
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `
        <i data-lucide="${type === 'success' ? 'check-circle' : 'alert-circle'}"></i>
        ${message}
      `;
      document.body.appendChild(toast);
      lucide.createIcons();
      
      setTimeout(() => {
        toast.style.animation = 'fadeIn 0.3s ease-out reverse';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
    
    function parsePace(paceString) {
	  if (!paceString) return null;
	  const parts = paceString.split(':');
	  if (parts.length === 2) {
	    const mins = parseInt(parts[0]);
	    const secs = parseInt(parts[1]);
	    return mins * 60 + secs;
	  }
	  return null;
	}
	
	function formatPace(secondsPerKm) {
	  if (!secondsPerKm) return '';
	  const mins = Math.floor(secondsPerKm / 60);
	  const secs = secondsPerKm % 60;
	  return `${mins}:${String(secs).padStart(2, '0')}`;
	}

// ==================== SMART COACH PANEL ====================

    // ==================== SMART COACH PANEL ====================
    class SmartCoachPanel {

      constructor() {
        this.settings = null;
        this.loading = true;
        this.showSettingsModal = false;
        this.editingSettings = null;
        this.currentPlan = null;
        this.generatingPlan = false;
        this.init();
      }
      
      async init() {
        console.log('üöÄ Smart Coach initializing...');
        this.render();
        
        try {
          await waitForAuth();
          await this.loadSettings();
          
          // Load current plan if settings exist
          if (this.settings) {
            await this.loadCurrentPlan();
          }
          
          console.log('‚úÖ Initialization complete');
        } catch (error) {
          console.error('‚ùå Init error:', error);
          showToast('Error initializing', 'error');
          this.loading = false;
          this.render();
        }
        
        lucide.createIcons();
      }
      
      async loadSettings() {
        this.loading = true;
        this.render();
        
        try {
          const doc = await settingsRef.doc('settings').get();
          
          if (doc.exists) {
            this.settings = { id: doc.id, ...doc.data() };
            console.log('‚úÖ Settings loaded');
          } else {
            this.settings = null;
            console.log('‚ö†Ô∏è No settings - showing onboarding');
          }
          
          this.loading = false;
          this.render();
        } catch (error) {
          console.error('‚ùå Load error:', error);
          showToast('Error loading settings', 'error');
          this.loading = false;
          this.render();
        }
      }
      
      async saveSettings(settingsData) {
        try {
          console.log('üíæ Saving...');
          
          const toSave = {
            ...settingsData,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          };
          
          await settingsRef.doc('settings').set(toSave, { merge: true });
          console.log('‚úÖ Saved');
          showToast('Settings saved');
          
          await this.loadSettings();
          this.closeSettingsModal();
        } catch (error) {
          console.error('‚ùå Save error:', error);
          showToast('Error saving', 'error');
        }
      }
      
      // ==================== SESSION LOADING ====================
      
      async loadRecentSessions(weeks = 4) {
        try {
          console.log(`üìä Loading last ${weeks} weeks of sessions...`);
          
          const weeksAgo = new Date();
          weeksAgo.setDate(weeksAgo.getDate() - (weeks * 7));
          const cutoffDate = weeksAgo.toISOString().split('T')[0];
          
          const sessionsRef = db.collection('users').doc(currentUser.uid).collection('sessions');
          const snapshot = await sessionsRef
            .where('date', '>=', cutoffDate)
            .orderBy('date', 'desc')
            .get();
          
          const sessions = [];
          snapshot.forEach(doc => {
            sessions.push({ id: doc.id, ...doc.data() });
          });
          
          console.log(`‚úÖ Loaded ${sessions.length} sessions`);
          return sessions;
        } catch (error) {
          console.error('‚ùå Error loading sessions:', error);
          return [];
        }
      }
      
      // ==================== AI PLAN GENERATION ====================
      
      async generateWeeklyPlan() {
        try {
        	// In generateWeeklyPlan(), before the API call:
			const USE_MOCK = true; // Set to false when ready for real AI
			
			if (USE_MOCK) {
			  // Return mock plan for testing
			  const mockResponse = `{
			    "weeklyReview": "MOCK MODE: Testing plan display without API costs.",
			    "workouts": [
			      {"day": "Monday", "type": "Long Run", "distance": 20, "duration": 120, "pace": "6:00", "targetTSS": 140, "notes": "Progressive run"},
			      // ... 6 more days
			    ],
			    "weeklyTarget": {"totalDistance": 54, "totalTSS": 450}
			  }`;
			  
			const plan = this.parsePlanResponse(mockResponse, weekNumber, weekStartDate);
			  // Continue with save/display
			}
			
			console.log('üìã Sessions being sent to AI:', JSON.stringify(recentSessions, null, 2));
			console.log('üìà Metrics calculated:', metrics);


          // Check if API key is configured
          if (!this.settings.anthropicApiKey) {
            showToast('Please add your Anthropic API Key in Settings first', 'error');
            return;
          }
          
          this.generatingPlan = true;
          this.render();
          
          console.log('ü§ñ Generating weekly plan...');
          
          // Calculate current week info
          const weekNumber = calculateWeekNumber(this.settings.week1StartDate || '2025-11-10');
          const { mesocycleWeek, mesocycleType } = getMesocycleInfo(weekNumber);
          const weekStartDate = getWeekStartDate(weekNumber, this.settings.week1StartDate || '2025-11-10');
          
          // Load recent sessions for context
          const recentSessions = await this.loadRecentSessions(10);
          
          // Calculate current fitness metrics
          const metrics = calculatePerformanceMetrics(recentSessions);
          
          console.log('üìà Current metrics:', metrics);
          console.log(`üìÖ Week ${weekNumber} (Mesocycle ${mesocycleWeek}/4 - ${mesocycleType})`);
          
          // Build AI prompt
          const prompt = this.buildPlanPrompt(weekNumber, mesocycleWeek, mesocycleType, metrics, recentSessions);
          
          // Call Anthropic API
		 const response = await fetch('https://running-coach-api-proxy.nicoca17.workers.dev', {
			  method: 'POST',
			  headers: {
			    'Content-Type': 'application/json'
			  },
			  body: JSON.stringify({
			    model: 'claude-sonnet-4-20250514',
			    max_tokens: 4096,
			    messages: [{
			      role: 'user',
			      content: prompt
			    }]
			  })
			});
          
			          
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            console.error('API Error:', response.status, errorData);
            
            if (response.status === 401) {
              throw new Error('Invalid API Key. Please check your Anthropic API Key in Settings.');
            } else if (response.status === 429) {
              throw new Error('API rate limit reached. Please try again in a few moments.');
            } else {
              throw new Error(`API Error: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
            }
          }
          
          const data = await response.json();
          const aiResponse = data.content[0].text;
          
          console.log('ü§ñ AI Response received');
          
          // Parse the plan from AI response
          const plan = this.parsePlanResponse(aiResponse, weekNumber, weekStartDate);
          
          // Save plan to Firebase with DRAFT status
          await this.savePlan(plan);
          
          showToast('Weekly plan generated!');
          this.generatingPlan = false;
          await this.loadCurrentPlan();
          this.render();
          
        } catch (error) {
          console.error('‚ùå Plan generation error:', error);
          showToast('Error generating plan', 'error');
          this.generatingPlan = false;
          this.render();
        }
      }
      
      buildPlanPrompt(weekNumber, mesocycleWeek, mesocycleType, metrics, recentSessions) {
        const s = this.settings;
        
        // Format recent sessions for context
        const sessionsSummary = recentSessions.slice(0, 10).map(session => {
          const paceStr = session.avgPace ? formatPace(session.avgPace) : 'N/A';
          return `${session.date}: ${session.type} - ${session.distance}km, ${session.duration}min, Pace: ${paceStr}/km, TSS: ${session.tss || 0}`;
        }).join('\n');
        
        // Build comprehensive prompt
        return `You are an expert marathon running coach. Generate a detailed 7-day training plan for next week.

ATHLETE PROFILE:
- Goal: ${s.goalDistance} in ${s.targetTime}
- Target Race Date: ${s.targetRaceDate || 'TBD'}
- Current Phase: ${s.currentPhase}
- Week ${weekNumber} (Mesocycle Week ${mesocycleWeek}/4 - ${mesocycleType} Week)

CURRENT FITNESS:
- CTL (Chronic Training Load): ${metrics.ctl}
- ATL (Acute Training Load): ${metrics.atl}
- TSB (Training Stress Balance): ${metrics.tsb}

CONSTRAINTS:
- Available Days: ${s.availableDays ? s.availableDays.join(', ') : 'Not specified'}
- Fixed Activities:
  ${Object.entries(s.fixedActivities || {}).map(([day, activity]) => 
    `  ${day}: ${activity.type} (${activity.priority})`
  ).join('\n  ')}
- Preferred Long Run Day: ${s.preferredLongRunDay || 'Monday'}
- Active Injury: ${s.activeInjuries && s.activeInjuries.length > 0 ? s.activeInjuries[0].notes : 'None'}

RECENT TRAINING (Last 10 sessions):
${sessionsSummary}

PHYSIOLOGICAL DATA:
- LTHR: ${s.lthr || 165} bpm
- Max HR: ${s.maxHr || 188} bpm
- Easy Pace: ${formatPace(s.easyPaceRange?.min || 380)} - ${formatPace(s.easyPaceRange?.max || 400)}/km

INSTRUCTIONS:
Generate a 7-day plan (Monday to Sunday) in STRICT JSON format. Each day must include:
- day: Day name
- type: Workout type (e.g., "Easy Run", "Long Run", "Interval Training", "Rest", "Futsal", "Pedicab", etc.)
- distance: Distance in km (0 for rest days)
- duration: Duration in minutes (0 for rest)
- pace: Target pace in MM:SS format (or "Easy", "Moderate", "Hard")
- targetTSS: Estimated Training Stress Score
- notes: Detailed workout description and coaching cues

Consider:
1. This is a ${mesocycleType} week (${mesocycleType === 'Discharge' ? 'recovery week, reduce volume by 20-30%' : 'building week'})
2. Respect fixed activities and available days
3. Balance intensity based on current TSB
4. Progress gradually from recent training load
5. Include specific pacing zones and workout structure
6. Account for any active injuries

Respond with ONLY valid JSON in this exact format:
{
  "weeklyReview": "Brief analysis of recent training and this week's focus",
  "workouts": [
    {
      "day": "Monday",
      "type": "Long Run",
      "distance": 20,
      "duration": 120,
      "pace": "6:00",
      "targetTSS": 140,
      "notes": "Progressive long run. Start at easy pace, finish at moderate pace. Focus on consistent rhythm."
    }
    // ... 6 more days
  ],
  "weeklyTarget": {
    "totalDistance": 60,
    "totalTSS": 450
  }
}`;
      }
      
      parsePlanResponse(aiResponse, weekNumber, weekStartDate) {
        try {
          // Extract JSON from response (handle potential markdown formatting)
          let jsonStr = aiResponse;
          
          // Remove markdown code blocks if present
          if (jsonStr.includes('```json')) {
            jsonStr = jsonStr.split('```json')[1].split('```')[0];
          } else if (jsonStr.includes('```')) {
            jsonStr = jsonStr.split('```')[1].split('```')[0];
          }
          
          const parsed = JSON.parse(jsonStr.trim());
          
          // Build plan document
          return {
            weekNumber,
            weekStartDate,
            status: 'DRAFT',
            generatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            weeklyReview: parsed.weeklyReview || '',
            workouts: parsed.workouts || [],
            weeklyTarget: parsed.weeklyTarget || { totalDistance: 0, totalTSS: 0 },
            version: 1,
            regenerations: []
          };
        } catch (error) {
          console.error('‚ùå Parse error:', error);
          console.log('Raw AI response:', aiResponse);
          throw new Error('Failed to parse AI response');
        }
      }
      
      async savePlan(plan) {
        try {
          const plansRef = db.collection('users').doc(currentUser.uid).collection('plans');
          await plansRef.doc(plan.weekStartDate).set(plan);
          console.log('‚úÖ Plan saved:', plan.weekStartDate);
        } catch (error) {
          console.error('‚ùå Error saving plan:', error);
          throw error;
        }
      }
      
      async loadCurrentPlan() {
        try {
          const weekNumber = calculateWeekNumber(this.settings.week1StartDate || '2025-11-10');
          const weekStartDate = getWeekStartDate(weekNumber, this.settings.week1StartDate || '2025-11-10');
          
          const plansRef = db.collection('users').doc(currentUser.uid).collection('plans');
          const doc = await plansRef.doc(weekStartDate).get();
          
          if (doc.exists) {
            this.currentPlan = { id: doc.id, ...doc.data() };
            console.log('‚úÖ Current plan loaded');
          } else {
            this.currentPlan = null;
            console.log('‚ö†Ô∏è No plan for current week');
          }
          
          this.render();
        } catch (error) {
          console.error('‚ùå Error loading plan:', error);
        }
      }
      
      openSettingsModal() {
		  // Merge existing settings with defaults to ensure all fields exist
		  const defaults = this.getDefaultSettings();
		  this.editingSettings = this.settings ? { 
			...defaults,           // Start with complete defaults
			...this.settings,      // Override with saved settings
			// Ensure nested objects are properly merged
			easyPaceRange: this.settings.easyPaceRange || defaults.easyPaceRange,
			fixedActivities: this.settings.fixedActivities || defaults.fixedActivities
		  } : defaults;
		  
		  this.showSettingsModal = true;
		  this.editingFixedActivities = { ...this.editingSettings.fixedActivities };
		  this.render();
		  setTimeout(() => {
			this.renderFixedActivitiesList();
		  }, 10);
		}
      
      closeSettingsModal() {
        this.showSettingsModal = false;
        this.editingSettings = null;
        this.render();
        lucide.createIcons();
      }
      
      getDefaultSettings() {
        return {
          goalDistance: 'Marathon',
          targetTime: '3:25:00',
          targetRaceDate: null,
          currentPhase: 'Base',
          availableDays: ['Monday', 'Wednesday', 'Thursday', 'Sunday'],
          fixedActivities: {
            Tuesday: { type: 'Futsal', priority: 'immovable', defaults: { distance: 8, duration: 60, tss: 95 } },
            Saturday: { type: 'Pedicab', priority: 'immovable', defaults: { distance: 18, duration: 360, tss: 72 } },
            Friday: { type: 'Rest', priority: 'immovable' }
          },
          preferredLongRunDay: 'Monday',
          preferredRestDay: 'Friday',
          lthr: 165,
          maxHr: 188,
          easyPaceRange: { min: 380, max: 400 },
          activeInjuries: [
            { location: 'left_calf', status: 'monitor', since: '2025-11-01', notes: 'Occasional tightness' }
          ],
          maxWeeklyVolumeKm: 60,
          volumeProgressionLimit: 10,
          week1StartDate: '2025-11-10',
          autoApprovePlans: false,
          anthropicApiKey: null
        };
      }
      
      handleSaveSettings() {
        try {
          const availableDays = [];
          document.querySelectorAll('.available-day:checked').forEach(cb => availableDays.push(cb.value));
          
          const injuryLocation = document.getElementById('injuryLocation').value;
          const injurySince = document.getElementById('injurySince').value;
          
          const settingsData = {
			  goalDistance: document.getElementById('goalDistance').value,
			  targetTime: document.getElementById('targetTime').value,
			  targetRaceDate: document.getElementById('targetRaceDate').value || null,
			  currentPhase: document.getElementById('currentPhase').value,
			  availableDays: availableDays,
			  fixedActivities: this.editingFixedActivities || {}, // ‚úÖ Default to empty object
			  preferredLongRunDay: document.getElementById('preferredLongRunDay').value,
			preferredRestDay: document.getElementById('preferredRestDay').value,
			lthr: parseInt(document.getElementById('lthr').value) || 165,
			maxHr: parseInt(document.getElementById('maxHr').value) || 188,
			easyPaceRange: {
			  min: parsePace(document.getElementById('easyPaceMin').value) || 380,
			  max: parsePace(document.getElementById('easyPaceMax').value) || 400
			}, 
            activeInjuries: injuryLocation ? [{
              location: injuryLocation.toLowerCase().replace(/ /g, '_'),
              status: 'monitor',
              since: injurySince || new Date().toISOString().split('T')[0],
              notes: injuryLocation
            }] : [],
            maxWeeklyVolumeKm: this.editingSettings.maxWeeklyVolumeKm || 60,
            volumeProgressionLimit: this.editingSettings.volumeProgressionLimit || 10,
            week1StartDate: this.editingSettings.week1StartDate || '2025-11-10',
            autoApprovePlans: this.editingSettings.autoApprovePlans || false,
            anthropicApiKey: document.getElementById('anthropicApiKey').value || null
          };
          
          this.saveSettings(settingsData);
        } catch (error) {
          console.error('‚ùå Gather error:', error);
          showToast('Error saving', 'error');
        }
      }
	  
	  addFixedActivity() {
		  const day = prompt('Which day? (e.g., Tuesday, Saturday)');
		  if (!day) return;
		  
		  const activity = prompt('Activity name? (e.g., Futsal, Pedicab, Rest)');
		  if (!activity) return;
		  
		  if (!this.editingFixedActivities) {
			this.editingFixedActivities = {};
		  }
		  
		  this.editingFixedActivities[day] = {
			type: activity,
			priority: 'immovable',
			defaults: { distance: 0, duration: 60, tss: 0 }
		  };
		  
		  this.renderFixedActivitiesList();
		}

		removeFixedActivity(day) {
		  if (confirm(`Remove ${day} activity?`)) {
			delete this.editingFixedActivities[day];
			this.renderFixedActivitiesList();
		  }
		}

		renderFixedActivitiesList() {
		  const container = document.getElementById('fixedActivitiesList');
		  if (!container) return;
		  
		  const activities = this.editingFixedActivities || {};
		  
		  if (Object.keys(activities).length === 0) {
			container.innerHTML = '<p style="color: #64748b; font-style: italic;">No fixed activities yet</p>';
		  } else {
			container.innerHTML = Object.keys(activities).map(day => {
			  const activity = activities[day];
			  return `
				<div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(245, 158, 11, 0.05); border-radius: 8px;">
				  <span style="width: 100px; font-weight: 600;">${day}:</span>
				  <span style="flex: 1; color: #f59e0b;">${activity.type}</span>
				  <span class="badge badge-immovable">Immovable</span>
				  <button onclick="app.removeFixedActivity('${day}')" style="color: #f43f5e; background: none; border: none; cursor: pointer; padding: 4px;">
					<i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
				  </button>
				</div>
			  `;
			}).join('');
		  }
		  
		  lucide.createIcons();
		}
      
      render() {
        const app = document.getElementById('app');
        if (!app) return;
        
        try {
          let html = this.loading ? this.renderLoading() : 
                     !this.settings ? this.renderOnboarding() : 
                     this.renderMainContent();
          
          if (this.showSettingsModal) html += this.renderSettingsModal();
          
          app.innerHTML = html;
          lucide.createIcons();
        } catch (error) {
          console.error('‚ùå Render error:', error);
          app.innerHTML = '<div style="color: #f43f5e; padding: 40px; text-align: center;">Error rendering. Check console.</div>';
        }
      }
      
      renderLoading() {
        return `
          <div style="display: flex; align-items: center; justify-content: center; height: 70vh;">
            <div style="text-align: center;">
              <div class="spinner" style="margin: 0 auto 16px;"></div>
              <p style="color: #94a3b8;">Loading Smart Coach...</p>
            </div>
          </div>
        `;
      }
      
      renderOnboarding() {
        return `
          <div style="max-width: 600px; margin: 48px auto;">
            <div class="card" style="padding: 48px; text-align: center;">
              <div style="margin-bottom: 24px;">
                <div style="width: 80px; height: 80px; margin: 0 auto 16px; border-radius: 50%; background: rgba(59, 130, 246, 0.1); display: flex; align-items: center; justify-content: center;">
                  <i data-lucide="settings" style="width: 40px; height: 40px; color: #3b82f6;"></i>
                </div>
                <h2 style="font-size: 28px; font-weight: bold; margin-bottom: 12px;">Welcome to Smart Coach!</h2>
                <p style="color: #94a3b8; font-size: 16px;">
                  Let's set up your training preferences to get started with AI-powered coaching
                </p>
              </div>
              
              <button onclick="app.openSettingsModal()" class="btn-primary" style="font-size: 16px;">
                <i data-lucide="play"></i>
                Set Up Training Settings
              </button>
            </div>
          </div>
        `;
      }
      
      renderMainContent() {
        const s = this.settings;
        const fixedDays = Object.keys(s.fixedActivities || {}).map(day => 
          `${day} (${s.fixedActivities[day].type})`
        ).join(', ');
        
        const injury = s.activeInjuries && s.activeInjuries.length > 0 
          ? s.activeInjuries[0].location.replace('_', ' ')
          : 'None';
        
        return `
          <div class="max-w-7xl mx-auto">
            <div class="mb-8 fade-in">
              <h1 class="text-4xl font-bold gradient-text flex items-center gap-3 mb-2">
                <i data-lucide="brain"></i>
                AI Smart Coach
              </h1>
              <p style="color: #94a3b8;">Intelligent training planning powered by AI</p>
            </div>
            
            <div class="settings-bar fade-in">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; flex-wrap: wrap;">
                <div style="flex: 1; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                  <div class="settings-item">
                    <i data-lucide="target" style="width: 20px; height: 20px; color: #3b82f6;"></i>
                    <div style="font-size: 14px; color: #94a3b8;">
                      Goal: <span style="font-weight: 600; color: #f8fafc;">${s.goalDistance} ${s.targetTime}</span>
                    </div>
                  </div>
                  
                  <div class="settings-item">
                    <i data-lucide="calendar" style="width: 20px; height: 20px; color: #3b82f6;"></i>
                    <div style="font-size: 14px; color: #94a3b8;">
                      Phase: <span style="font-weight: 600; color: #f8fafc;">${s.currentPhase}</span>
                    </div>
                  </div>
                  
                  <div class="settings-item">
                    <i data-lucide="calendar-check" style="width: 20px; height: 20px; color: #3b82f6;"></i>
                    <div style="font-size: 14px; color: #94a3b8;">
                      Available: <span style="font-weight: 600; color: #f8fafc;">${s.availableDays ? s.availableDays.length : 0} days</span>
                    </div>
                  </div>
                  
                  <div class="settings-item">
                    <i data-lucide="lock" style="width: 20px; height: 20px; color: #3b82f6;"></i>
                    <div style="font-size: 14px; color: #94a3b8;">
                      Fixed: <span style="font-weight: 600; color: #f8fafc;">${fixedDays || 'None'}</span>
                    </div>
                  </div>
                  
                  <div class="settings-item">
                    <i data-lucide="activity" style="width: 20px; height: 20px; color: #3b82f6;"></i>
                    <div style="font-size: 14px; color: #94a3b8;">
                      LTHR: <span style="font-weight: 600; color: #f8fafc;">${s.lthr} bpm</span>
                    </div>
                  </div>
                  
                  <div class="settings-item">
                    <i data-lucide="alert-circle" style="width: 20px; height: 20px; color: #3b82f6;"></i>
                    <div style="font-size: 14px; color: #94a3b8;">
                      Injury: <span style="font-weight: 600; color: #f8fafc;">${injury}</span>
                    </div>
                  </div>
                </div>
                
                <button onclick="app.openSettingsModal()" class="btn-secondary" style="flex-shrink: 0;">
                  <i data-lucide="settings"></i>
                  Edit Settings
                </button>
              </div>
            </div>
            
            ${this.renderPlanSection()}
          </div>
        `;
      }
      
      renderPlanSection() {
        const s = this.settings;
        const weekNumber = calculateWeekNumber(s.week1StartDate || '2025-11-10');
        const { mesocycleWeek, mesocycleType } = getMesocycleInfo(weekNumber);
        const weekStartDate = getWeekStartDate(weekNumber, s.week1StartDate || '2025-11-10');
        
        // Format week start date for display
        const dateObj = new Date(weekStartDate);
        const formattedDate = dateObj.toLocaleDateString('en-AU', { 
          weekday: 'long', 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        });
        
        return `
          <!-- Week Header -->
          <div class="card fade-in" style="padding: 24px; margin-bottom: 24px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(16, 185, 129, 0.1) 100%);">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
              <div>
                <h2 style="font-size: 28px; font-weight: bold; margin-bottom: 4px;">
                  Week ${weekNumber}
                  <span style="font-size: 18px; color: #94a3b8; font-weight: normal;">
                    / Mesocycle Week ${mesocycleWeek}/4
                  </span>
                </h2>
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                  <span class="badge" style="${mesocycleType === 'Discharge' ? 'background: rgba(245, 158, 11, 0.2); color: var(--accent-amber);' : 'background: rgba(16, 185, 129, 0.2); color: var(--accent-emerald);'}">
                    <i data-lucide="${mesocycleType === 'Discharge' ? 'trending-down' : 'trending-up'}" style="width: 14px; height: 14px;"></i>
                    ${mesocycleType} Week
                  </span>
                </div>
                <p style="color: #94a3b8; font-size: 14px;">
                  <i data-lucide="calendar" style="width: 14px; height: 14px;"></i>
                  Starting ${formattedDate}
                </p>
              </div>
              
              <button 
                onclick="app.generateWeeklyPlan()" 
                class="btn-primary"
                ${this.generatingPlan ? 'disabled' : ''}
                style="${this.generatingPlan ? 'opacity: 0.5; cursor: not-allowed;' : ''}"
              >
                ${this.generatingPlan ? '<div class="spinner" style="width: 20px; height: 20px; border-width: 2px;"></div>' : '<i data-lucide="sparkles"></i>'}
                ${this.generatingPlan ? 'Generating...' : 'Generate Next Week\'s Plan'}
              </button>
            </div>
          </div>
          
          ${this.currentPlan ? this.renderCurrentPlan() : this.renderNoPlan()}
        `;
      }
      
      renderNoPlan() {
        return `
          <div class="card fade-in" style="padding: 48px; text-align: center;">
            <i data-lucide="calendar-x" style="width: 64px; height: 64px; margin: 0 auto 16px; color: #64748b;"></i>
            <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 8px; color: #94a3b8;">No Plan Generated Yet</h3>
            <p style="color: #64748b; margin-bottom: 24px;">
              Click "Generate Next Week's Plan" to create your AI-powered training schedule
            </p>
          </div>
        `;
      }
      
      renderCurrentPlan() {
        const plan = this.currentPlan;
        const statusColors = {
          'DRAFT': 'rgba(245, 158, 11, 0.2)',
          'APPROVED': 'rgba(16, 185, 129, 0.2)',
          'IN_PROGRESS': 'rgba(59, 130, 246, 0.2)',
          'COMPLETED': 'rgba(148, 163, 184, 0.2)'
        };
        
        const statusColor = statusColors[plan.status] || statusColors['DRAFT'];
        
        return `
          <!-- Weekly Review -->
          ${plan.weeklyReview ? `
            <div class="card fade-in" style="padding: 24px; margin-bottom: 24px;">
              <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                <i data-lucide="clipboard" style="width: 20px; height: 20px; color: #3b82f6;"></i>
                Weekly Review
              </h3>
              <p style="color: #cbd5e1; line-height: 1.6;">${plan.weeklyReview}</p>
            </div>
          ` : ''}
          
          <!-- Plan Status -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h3 style="font-size: 20px; font-weight: 600;">Training Plan</h3>
            <span class="badge" style="background: ${statusColor}; padding: 6px 12px;">
              <i data-lucide="check-circle" style="width: 14px; height: 14px;"></i>
              ${plan.status}
            </span>
          </div>
          
          <!-- Week Target Summary -->
          <div class="card fade-in" style="padding: 20px; margin-bottom: 24px; background: rgba(59, 130, 246, 0.05);">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
              <div>
                <div style="color: #94a3b8; font-size: 12px; margin-bottom: 4px;">Total Distance</div>
                <div style="font-size: 24px; font-weight: bold; color: #3b82f6;">
                  ${plan.weeklyTarget?.totalDistance || 0} <span style="font-size: 14px; color: #94a3b8;">km</span>
                </div>
              </div>
              <div>
                <div style="color: #94a3b8; font-size: 12px; margin-bottom: 4px;">Total TSS</div>
                <div style="font-size: 24px; font-weight: bold; color: #10b981;">
                  ${plan.weeklyTarget?.totalTSS || 0} <span style="font-size: 14px; color: #94a3b8;">points</span>
                </div>
              </div>
              <div>
                <div style="color: #94a3b8; font-size: 12px; margin-bottom: 4px;">Workouts</div>
                <div style="font-size: 24px; font-weight: bold; color: #f59e0b;">
                  ${plan.workouts?.length || 0} <span style="font-size: 14px; color: #94a3b8;">days</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Workout Cards -->
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">
            ${plan.workouts?.map((workout, index) => this.renderWorkoutCard(workout, index)).join('') || ''}
          </div>
        `;
      }
      
      renderWorkoutCard(workout, index) {
        const typeColors = {
          'Long Run': '#3b82f6',
          'Easy Run': '#10b981',
          'Interval Training': '#f43f5e',
          'Tempo Run': '#f59e0b',
          'Rest': '#64748b',
          'Futsal': '#8b5cf6',
          'Pedicab': '#06b6d4'
        };
        
        const color = typeColors[workout.type] || '#94a3b8';
        
        return `
          <div class="card fade-in" style="padding: 20px; animation-delay: ${index * 0.05}s;">
            <div style="margin-bottom: 12px;">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                <h4 style="font-size: 16px; font-weight: 600; color: ${color};">
                  ${workout.day}
                </h4>
                <span style="font-size: 12px; padding: 4px 8px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; color: #3b82f6;">
                  TSS ${workout.targetTSS || 0}
                </span>
              </div>
              <div style="font-size: 18px; font-weight: bold; margin-bottom: 4px;">${workout.type}</div>
              
              ${workout.distance > 0 ? `
                <div style="display: flex; gap: 16px; color: #94a3b8; font-size: 14px; margin-bottom: 8px;">
                  <div>
                    <i data-lucide="map" style="width: 14px; height: 14px;"></i>
                    ${workout.distance} km
                  </div>
                  <div>
                    <i data-lucide="clock" style="width: 14px; height: 14px;"></i>
                    ${workout.duration} min
                  </div>
                  ${workout.pace && workout.pace !== 'Rest' ? `
                    <div>
                      <i data-lucide="gauge" style="width: 14px; height: 14px;"></i>
                      ${workout.pace}${workout.pace.includes(':') ? '/km' : ''}
                    </div>
                  ` : ''}
                </div>
              ` : ''}
            </div>
            
            <div style="padding: 12px; background: rgba(255, 255, 255, 0.02); border-radius: 8px; border-left: 3px solid ${color};">
              <p style="color: #cbd5e1; font-size: 13px; line-height: 1.5; margin: 0;">
                ${workout.notes || 'No additional notes'}
              </p>
            </div>
          </div>
        `;
      }
      
      renderSettingsModal() {
 		 const s = this.editingSettings;
 		 
 		 // Pre-calculate pace values to avoid scope issues
 		 const easyPaceMinDisplay = formatPace(s.easyPaceRange?.min || 380);
 		 const easyPaceMaxDisplay = formatPace(s.easyPaceRange?.max || 400);
 		 
 		 const settingsFormHTML = `

          <!-- Goal -->
          <div style="margin-bottom: 24px;">
            <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
              <i data-lucide="target" style="width: 20px; height: 20px; color: #3b82f6;"></i>
              Goal
            </h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
              <div>
                <label style="display: block; font-size: 14px; color: #94a3b8; margin-bottom: 8px;">Distance</label>
                <select id="goalDistance" class="input-field">
                  <option value="5K">5K</option>
                  <option value="10K">10K</option>
                  <option value="Half">Half Marathon</option>
                  <option value="Marathon" selected>Marathon</option>
                </select>
              </div>
              <div>
                <label style="display: block; font-size: 14px; color: #94a3b8; margin-bottom: 8px;">Target Time</label>
                <input type="text" id="targetTime" class="input-field" value="${s.targetTime || ''}" placeholder="3:25:00">
              </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-top: 16px;">
              <div>
                <label style="display: block; font-size: 14px; color: #94a3b8; margin-bottom: 8px;">Race Date (optional)</label>
                <input type="date" id="targetRaceDate" class="input-field" value="${s.targetRaceDate || ''}">
              </div>
              <div>
                <label style="display: block; font-size: 14px; color: #94a3b8; margin-bottom: 8px;">Current Phase</label>
                <select id="currentPhase" class="input-field">
                  <option value="Base" selected>Base</option>
                  <option value="Build">Build</option>
                  <option value="Specialty">Specialty</option>
                  <option value="Taper">Taper</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- Availability -->
          <div style="margin-bottom: 24px;">
            <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
              <i data-lucide="calendar-check" style="width: 20px; height: 20px; color: #3b82f6;"></i>
              Availability
            </h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" class="available-day" value="Monday" ${s.availableDays && s.availableDays.includes('Monday') ? 'checked' : ''} style="width: 20px; height: 20px; accent-color: #3b82f6;">
                <span>Monday</span>
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" class="available-day" value="Tuesday" ${s.availableDays && s.availableDays.includes('Tuesday') ? 'checked' : ''} style="width: 20px; height: 20px; accent-color: #3b82f6;">
                <span>Tuesday</span>
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" class="available-day" value="Wednesday" ${s.availableDays && s.availableDays.includes('Wednesday') ? 'checked' : ''} style="width: 20px; height: 20px; accent-color: #3b82f6;">
                <span>Wednesday</span>
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" class="available-day" value="Thursday" ${s.availableDays && s.availableDays.includes('Thursday') ? 'checked' : ''} style="width: 20px; height: 20px; accent-color: #3b82f6;">
                <span>Thursday</span>
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" class="available-day" value="Friday" ${s.availableDays && s.availableDays.includes('Friday') ? 'checked' : ''} style="width: 20px; height: 20px; accent-color: #3b82f6;">
                <span>Friday</span>
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" class="available-day" value="Saturday" ${s.availableDays && s.availableDays.includes('Saturday') ? 'checked' : ''} style="width: 20px; height: 20px; accent-color: #3b82f6;">
                <span>Saturday</span>
              </label>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" class="available-day" value="Sunday" ${s.availableDays && s.availableDays.includes('Sunday') ? 'checked' : ''} style="width: 20px; height: 20px; accent-color: #3b82f6;">
                <span>Sunday</span>
              </label>
            </div>
          </div>
          
          <!-- Fixed Activities -->
			<div style="margin-bottom: 24px;">
			  <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
				<i data-lucide="lock" style="width: 20px; height: 20px; color: #f59e0b;"></i>
				Fixed Activities
			  </h3>
			  <p style="font-size: 14px; color: #94a3b8; margin-bottom: 12px;">Recurring commitments on specific days</p>
			  
			  <div id="fixedActivitiesList" style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 12px;">
				<!-- Will be populated dynamically -->
			  </div>
			  
			  <button onclick="app.addFixedActivity()" class="btn-secondary" style="width: 100%;">
				<i data-lucide="plus"></i>
				Add Fixed Activity
			  </button>
			</div>
          
          <!-- Preferences -->
          <div style="margin-bottom: 24px;">
            <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
              <i data-lucide="star" style="width: 20px; height: 20px; color: #3b82f6;"></i>
              Preferences
            </h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
              <div>
                <label style="display: block; font-size: 14px; color: #94a3b8; margin-bottom: 8px;">Preferred Long Run Day</label>
                <select id="preferredLongRunDay" class="input-field">
                  <option value="Monday" selected>Monday</option>
                  <option value="Tuesday">Tuesday</option>
                  <option value="Wednesday">Wednesday</option>
                  <option value="Thursday">Thursday</option>
                  <option value="Friday">Friday</option>
                  <option value="Saturday">Saturday</option>
                  <option value="Sunday">Sunday</option>
                </select>
              </div>
              <div>
                <label style="display: block; font-size: 14px; color: #94a3b8; margin-bottom: 8px;">Preferred Rest Day</label>
                <select id="preferredRestDay" class="input-field">
                  <option value="Monday">Monday</option>
                  <option value="Tuesday">Tuesday</option>
                  <option value="Wednesday">Wednesday</option>
                  <option value="Thursday">Thursday</option>
                  <option value="Friday" selected>Friday</option>
                  <option value="Saturday">Saturday</option>
                  <option value="Sunday">Sunday</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- Injury -->
          <div style="margin-bottom: 24px;">
            <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
              <i data-lucide="alert-circle" style="width: 20px; height: 20px; color: #f43f5e;"></i>
              Injury Monitoring
            </h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
              <div>
                <label style="display: block; font-size: 14px; color: #94a3b8; margin-bottom: 8px;">Active Injury</label>
                <input type="text" id="injuryLocation" class="input-field" placeholder="e.g., Left calf - monitor" value="${s.activeInjuries && s.activeInjuries.length > 0 ? s.activeInjuries[0].notes : ''}">
              </div>
              <div>
                <label style="display: block; font-size: 14px; color: #94a3b8; margin-bottom: 8px;">Since</label>
                <input type="date" id="injurySince" class="input-field" value="${s.activeInjuries && s.activeInjuries.length > 0 ? s.activeInjuries[0].since : ''}">
              </div>
            </div>
          </div>
          

          <!-- Physiological Data -->
			<div>
			  <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
			    <i data-lucide="activity" style="width: 20px; height: 20px; color: #10b981;"></i>
			    Physiological Data
			  </h3>
			  <p style="font-size: 14px; color: #94a3b8; margin-bottom: 12px;">Auto-pulled from Analytics (editable)</p>
			  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
			    <div>
			      <label style="display: block; font-size: 14px; color: #94a3b8; margin-bottom: 8px;">LTHR (bpm)</label>
			      <input type="number" id="lthr" value="${s.lthr || 165}" class="input-field" placeholder="165">
			    </div>
			    <div>
			      <label style="display: block; font-size: 14px; color: #94a3b8; margin-bottom: 8px;">Max HR (bpm)</label>
			      <input type="number" id="maxHr" value="${s.maxHr || 188}" class="input-field" placeholder="188">
			    </div>
			    <div>
				  <label style="display: block; font-size: 14px; color: #94a3b8; margin-bottom: 8px;">Easy Pace Min (MM:SS)</label>
				  <input type="text" id="easyPaceMin" value="${easyPaceMinDisplay}" class="input-field" placeholder="6:20">
				</div>
				<div>
				  <label style="display: block; font-size: 14px; color: #94a3b8; margin-bottom: 8px;">Easy Pace Max (MM:SS)</label>
				  <input type="text" id="easyPaceMax" value="${easyPaceMaxDisplay}" class="input-field" placeholder="6:40">
				</div>
			  </div>
			</div>
			
			<!-- API Configuration -->
			<div style="margin-top: 24px;">
			  <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
			    <i data-lucide="key" style="width: 20px; height: 20px; color: #8b5cf6;"></i>
			    API Configuration
			  </h3>
			  <p style="font-size: 14px; color: #94a3b8; margin-bottom: 12px;">
			    Required for AI plan generation. 
			    <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color: #3b82f6; text-decoration: underline;">Get your free API key here</a>
			  </p>
			  <div>
			    <label style="display: block; font-size: 14px; color: #94a3b8; margin-bottom: 8px;">Anthropic API Key</label>
			    <input 
			      type="password" 
			      id="anthropicApiKey" 
			      value="${s.anthropicApiKey || ''}" 
			      class="input-field" 
			      placeholder="sk-ant-api03-..."
			      style="font-family: 'Space Mono', monospace; font-size: 13px;"
			    >
			    <p style="font-size: 12px; color: #64748b; margin-top: 6px;">
			      üîí Stored securely in your Firebase account. Never shared.
			    </p>
			  </div>
			</div>
        `;
        
        return `
          <div class="modal-backdrop" onclick="if(event.target === this) app.closeSettingsModal()">
            <div class="modal-content">
              <div style="padding: 24px; border-bottom: 1px solid #334155; display: flex; align-items: center; justify-content: space-between;">
                <h2 style="font-size: 24px; font-weight: bold; display: flex; align-items: center; gap: 8px;">
                  <i data-lucide="settings"></i>
                  Training Settings
                </h2>
                <button onclick="app.closeSettingsModal()" style="color: #94a3b8; cursor: pointer; background: none; border: none; padding: 4px;">
                  <i data-lucide="x" style="width: 24px; height: 24px;"></i>
                </button>
              </div>
              
              <div style="padding: 24px;">
                ${settingsFormHTML}
              </div>
              
              <div style="padding: 24px; border-top: 1px solid #334155; display: flex; justify-content: flex-end; gap: 12px;">
                <button onclick="app.closeSettingsModal()" class="btn-secondary">Cancel</button>
                <button onclick="app.handleSaveSettings()" class="btn-success">
                  <i data-lucide="save"></i>
                  Save Settings
                </button>
              </div>
            </div>
          </div>
        `;
      }
    }
    
    // Initialize
    const app = new SmartCoachPanel();
    window.app = app;
  </script>
</body>
</html>
