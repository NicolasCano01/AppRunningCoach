<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Running Coach Pro - Analytics</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/prop-types@15.8.1/prop-types.js"></script>
  <script crossorigin src="https://unpkg.com/recharts@2.1.16/umd/Recharts.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    :root {
      --bg-primary: #0a0f1a;
      --bg-card: #1a2332;
      --accent-blue: #3b82f6;
      --accent-emerald: #10b981;
      --accent-amber: #f59e0b;
      --accent-rose: #f43f5e;
      --text-primary: #f8fafc;
      --text-secondary: #94a3b8;
      --border-color: #334155;
    }
    
    * { font-family: 'DM Sans', sans-serif; box-sizing: border-box; }
    .mono { font-family: 'Space Mono', monospace; }
    
    body {
      background: linear-gradient(135deg, var(--bg-primary) 0%, #0f172a 50%, #1e1b4b 100%);
      min-height: 100vh;
      color: var(--text-primary);
      margin: 0;
      padding: 0;
      padding-bottom: 80px; /* Space for bottom nav */
    }
    
    /* BOTTOM NAVIGATION */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(26, 35, 50, 0.98);
      backdrop-filter: blur(20px);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding-bottom: env(safe-area-inset-bottom);
      z-index: 1000;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
    }
    
    .bottom-nav-container {
      display: flex;
      justify-content: space-around;
      align-items: center;
      max-width: 600px;
      margin: 0 auto;
      padding: 8px 16px;
    }
    
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 8px 12px;
      border-radius: 12px;
      text-decoration: none;
      color: var(--text-secondary);
      transition: all 0.2s;
      min-width: 60px;
      flex: 1;
      max-width: 90px;
    }
    
    .nav-item:hover {
      background: rgba(59, 130, 246, 0.1);
      color: var(--text-primary);
    }
    
    .nav-item.active {
      background: var(--accent-blue);
      color: white;
    }
    
    .nav-item svg {
      width: 24px;
      height: 24px;
    }
    
    .nav-item span {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    
    /* Compact date header */
    .date-header {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.05));
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 12px;
      padding: 12px 16px;
    }
    
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    @keyframes countUp { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
    
    .fade-in { animation: fadeIn 0.4s ease-out; }
    .slide-in { animation: slideIn 0.3s ease-out; }
    .count-up { animation: countUp 0.2s ease-out; }
    
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      transition: all 0.3s;
    }
    
    .card:hover {
      border-color: rgba(59, 130, 246, 0.3);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    /* Compact metric cards */
    .metric-card {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.05));
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 12px;
      padding: 12px;
      transition: all 0.3s;
      position: relative;
    }
    
    .metric-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(59, 130, 246, 0.2);
    }
    
    /* Icon in corner */
    .metric-card .corner-icon {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 16px;
      height: 16px;
      opacity: 0.6;
    }
    
    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.2s;
      cursor: pointer;
      border: none;
    }
    
    .btn-primary {
      background: var(--accent-blue);
      color: white;
    }
    
    .btn-primary:hover {
      background: #2563eb;
      transform: translateY(-1px);
    }
    
    .btn-secondary {
      background: rgba(59, 130, 246, 0.1);
      color: var(--accent-blue);
      border: 1px solid var(--accent-blue);
    }
    
    .btn-secondary:hover {
      background: rgba(59, 130, 246, 0.2);
    }
    
    .help-btn {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: rgba(59, 130, 246, 0.2);
      border: 1px solid var(--accent-blue);
      color: var(--accent-blue);
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: help;
      transition: all 0.2s;
    }
    
    .help-btn:hover {
      background: rgba(59, 130, 246, 0.3);
      transform: scale(1.1);
    }
    
    /* Quick filter pills */
    .filter-pills {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      padding: 12px 0;
    }
    
    .filter-pill {
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      border: 1px solid var(--border-color);
      background: rgba(26, 35, 50, 0.5);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .filter-pill:hover {
      border-color: var(--accent-blue);
      color: var(--accent-blue);
    }
    
    .filter-pill.active {
      background: var(--accent-blue);
      border-color: var(--accent-blue);
      color: white;
    }
    
    /* Gauge styles */
    .gauge-container {
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    
    .gauge-svg {
      transform: rotate(-90deg);
    }
    
    .gauge-bg {
      fill: none;
      stroke: rgba(255, 255, 255, 0.1);
      stroke-width: 8;
    }
    
    .gauge-fill {
      fill: none;
      stroke-width: 8;
      stroke-linecap: round;
      transition: stroke-dashoffset 0.5s ease;
    }
    
    .gauge-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }
    
    /* Progress ring gauge (alternative style) */
    .progress-ring {
      width: 80px;
      height: 80px;
      position: relative;
    }
    
    .progress-ring-circle {
      fill: none;
      stroke-width: 6;
    }
    
    .progress-ring-bg {
      stroke: rgba(255, 255, 255, 0.1);
    }
    
    .progress-ring-progress {
      stroke-linecap: round;
      transition: stroke-dashoffset 0.5s ease;
      transform: rotate(-90deg);
      transform-origin: 50% 50%;
    }
    
    .modal-backdrop {
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(4px);
    }
    
    .gradient-text {
      background: linear-gradient(135deg, #3b82f6 0%, #06b6d4 50%, #10b981 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .zone-bar {
      height: 32px;
      border-radius: 8px;
      background: rgba(59, 130, 246, 0.1);
      overflow: hidden;
    }
    
    .zone-fill {
      height: 100%;
      transition: width 0.5s;
    }
    
    input[type="date"] {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 8px 12px;
      color: var(--text-primary);
      font-size: 14px;
    }
    
    input[type="date"]:focus {
      outline: none;
      border-color: var(--accent-blue);
    }
    
    /* Advanced filters collapsible */
    .advanced-filters {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    
    .advanced-filters.expanded {
      max-height: 200px;
    }
    
    @media (max-width: 640px) {
      .metric-card { padding: 10px; }
      
      .help-btn {
        width: 32px;
        height: 32px;
        font-size: 14px;
      }
      
      .btn {
        padding: 12px 18px;
        font-size: 15px;
        min-height: 44px;
      }
      
      .metric-card .text-3xl {
        font-size: 1.75rem;
      }
      
      .card {
        padding: 16px !important;
      }
      
      .recharts-wrapper {
        font-size: 11px;
      }
    }
    
    .spinner {
      border: 3px solid rgba(255, 255, 255, 0.1);
      border-top: 3px solid var(--accent-blue);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;
    const { LineChart, BarChart, PieChart, Pie, Line, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, Cell } = Recharts;

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCQr84Yu0lTkKMnqtgYDD5NP4i_n5qS4eM",
      authDomain: "runningcoachdata.firebaseapp.com",
      projectId: "runningcoachdata",
      storageBucket: "runningcoachdata.firebasestorage.app",
      messagingSenderId: "364279562892",
      appId: "1:364279562892:web:7acd6bbac8c8113177f1a9"
    };

    // Initialize Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }

    // Get current training week (weeks since training start)
    const getCurrentTrainingWeek = () => {
      const startDate = new Date('2025-11-10');
      const today = new Date();
      const diffTime = today - startDate;
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
      const weekNumber = Math.floor(diffDays / 7) + 1;
      return weekNumber > 0 ? weekNumber : 1;
    };

    // Animated Number Component with count-up
    const AnimatedNumber = ({ value, decimals = 0, suffix = '' }) => {
      const [displayValue, setDisplayValue] = useState(0);
      
      useEffect(() => {
        const targetValue = typeof value === 'number' ? value : 0;
        const duration = 200; // 200ms animation
        const steps = 20;
        const increment = (targetValue - displayValue) / steps;
        let currentStep = 0;
        
        const timer = setInterval(() => {
          currentStep++;
          if (currentStep >= steps) {
            setDisplayValue(targetValue);
            clearInterval(timer);
          } else {
            setDisplayValue(prev => prev + increment);
          }
        }, duration / steps);
        
        return () => clearInterval(timer);
      }, [value]);
      
      return (
        <span className="count-up">
          {displayValue.toFixed(decimals)}{suffix}
        </span>
      );
    };

    // Circular Gauge Component (Pie chart style)
    const CircularGauge = ({ value, max = 100, label, color, size = 80 }) => {
      const percentage = Math.min((value / max) * 100, 100);
      const circumference = 2 * Math.PI * 32;
      const offset = circumference - (percentage / 100) * circumference;
      
      return (
        <div className="gauge-container" style={{ width: size, height: size }}>
          <svg className="gauge-svg" width={size} height={size}>
            <circle className="gauge-bg" cx={size/2} cy={size/2} r="32" />
            <circle 
              className="gauge-fill" 
              cx={size/2} 
              cy={size/2} 
              r="32"
              stroke={color}
              strokeDasharray={circumference}
              strokeDashoffset={offset}
            />
          </svg>
          <div className="gauge-text">
            <div className="text-xl font-bold" style={{ color }}>{value}</div>
            <div className="text-xs text-slate-400">{label}</div>
          </div>
        </div>
      );
    };

    // Progress Ring Gauge Component (Ring style)
    const ProgressRing = ({ percentage, label, color, size = 80 }) => {
      const radius = 32;
      const circumference = 2 * Math.PI * radius;
      const offset = circumference - (percentage / 100) * circumference;
      
      return (
        <div className="progress-ring">
          <svg width={size} height={size}>
            <circle
              className="progress-ring-circle progress-ring-bg"
              cx={size/2}
              cy={size/2}
              r={radius}
            />
            <circle
              className="progress-ring-circle progress-ring-progress"
              cx={size/2}
              cy={size/2}
              r={radius}
              stroke={color}
              strokeDasharray={circumference}
              strokeDashoffset={offset}
            />
          </svg>
          <div className="gauge-text">
            <div className="text-xl font-bold" style={{ color }}>{percentage}%</div>
            <div className="text-xs text-slate-400">{label}</div>
          </div>
        </div>
      );
    };

    // Horizontal Progress Bar Gauge (Training Load Balance style)
    const HorizontalGauge = ({ value, min = -30, max = 30, label }) => {
      // Calculate position percentage (0-100)
      const range = max - min;
      const normalizedValue = Math.max(min, Math.min(max, value));
      const percentage = ((normalizedValue - min) / range) * 100;
      
      // Determine color and status based on TSB value
      let status, statusColor;
      if (value < -10) {
        status = 'Overreached';
        statusColor = '#f43f5e'; // red
      } else if (value < 0) {
        status = 'Fatigued';
        statusColor = '#f59e0b'; // amber
      } else if (value <= 5) {
        status = 'Optimal';
        statusColor = '#10b981'; // green
      } else {
        status = 'Recovered';
        statusColor = '#3b82f6'; // blue
      }
      
      return (
        <div className="w-full">
          <div className="flex justify-between items-center mb-3">
            <span className="text-sm font-semibold text-slate-300">{label}</span>
            <div className="flex items-center gap-2">
              <span className="text-2xl font-bold mono" style={{ color: statusColor }}>
                {value > 0 ? '+' : ''}{value}
              </span>
              <span className="text-sm font-bold" style={{ color: statusColor }}>{status}</span>
            </div>
          </div>
          
          {/* Progress bar with zones */}
          <div className="relative h-10 bg-slate-800/50 rounded-full overflow-hidden">
            {/* Zone colors */}
            <div className="absolute inset-0 flex">
              <div className="flex-1 bg-gradient-to-r from-rose-500/30 to-rose-500/20"></div>
              <div className="flex-1 bg-gradient-to-r from-amber-500/20 to-emerald-500/20"></div>
              <div className="flex-1 bg-gradient-to-r from-emerald-500/20 to-blue-500/30"></div>
            </div>
            
            {/* Marker */}
            <div 
              className="absolute top-0 bottom-0 w-1.5 bg-white shadow-lg transition-all duration-500"
              style={{ left: `${percentage}%`, transform: 'translateX(-50%)' }}
            >
              <div className="absolute -top-1.5 left-1/2 -translate-x-1/2 w-4 h-4 rounded-full bg-white shadow-lg border-2" style={{ borderColor: statusColor }}></div>
              <div className="absolute -bottom-1.5 left-1/2 -translate-x-1/2 w-4 h-4 rounded-full bg-white shadow-lg border-2" style={{ borderColor: statusColor }}></div>
            </div>
          </div>
          
          {/* Scale labels */}
          <div className="flex justify-between items-center mt-2">
            <span className="text-xs text-slate-500">Underloaded</span>
            <span className="text-xs text-slate-500">Optimal</span>
            <span className="text-xs text-slate-500">Overloaded</span>
          </div>
        </div>
      );
    };

    // Help Button Component
    const HelpButton = ({ helpKey, onClick }) => (
      <button 
        className="help-btn" 
        onClick={() => onClick(helpKey)}
        title="Click for help"
      >
        ?
      </button>
    );

    // Bottom Navigation Component
    const BottomNav = ({ currentPage }) => (
      <nav className="bottom-nav">
        <div className="bottom-nav-container">
          <a href="AnalyticsPanel.html" className={`nav-item ${currentPage === 'analytics' ? 'active' : ''}`}>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <line x1="18" y1="20" x2="18" y2="10"></line>
              <line x1="12" y1="20" x2="12" y2="4"></line>
              <line x1="6" y1="20" x2="6" y2="14"></line>
            </svg>
            <span>Analytics</span>
          </a>
          
          <a href="HistoryPanel.html" className={`nav-item ${currentPage === 'history' ? 'active' : ''}`}>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            <span>History</span>
          </a>
          
          <a href="SmartCoachPanel.html" className={`nav-item ${currentPage === 'coach' ? 'active' : ''}`}>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <circle cx="12" cy="8" r="7"></circle>
              <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline>
            </svg>
            <span>Coach</span>
          </a>
          
          <a href="#" className="nav-item" onClick={(e) => { e.preventDefault(); alert('Log Session modal coming soon!'); }}>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="16"></line>
              <line x1="8" y1="12" x2="16" y2="12"></line>
            </svg>
            <span>Log Session</span>
          </a>
          
          <a href="#" className={`nav-item ${currentPage === 'settings' ? 'active' : ''}`} onClick={(e) => { e.preventDefault(); alert('Settings coming soon!'); }}>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M12 1v6m0 6v6m0-6h6m-6 0H6m13.66-5.66L16 10m-8 8-3.66 3.66M1.34 6.34L5 10m8 8 3.66 3.66M18.66 1.34 15 5M9 15l-3.66 3.66"></path>
            </svg>
            <span>Settings</span>
          </a>
        </div>
      </nav>
    );

    // Main Analytics Dashboard Component
    function AnalyticsDashboard() {
      const [sessions, setSessions] = useState([]);
      const [loading, setLoading] = useState(true);
      const [user, setUser] = useState(null);
      const [timeRange, setTimeRange] = useState(30);
      const [customStartDate, setCustomStartDate] = useState('');
      const [customEndDate, setCustomEndDate] = useState('');
      const [showHelp, setShowHelp] = useState(false);
      const [helpTopic, setHelpTopic] = useState('');
      const [showAdvancedFilters, setShowAdvancedFilters] = useState(false);

      // Auth & Data Loading
      useEffect(() => {
        const auth = firebase.auth();
        auth.signInWithEmailAndPassword('nic@runningcoach.com', 'policias')
          .then((userCredential) => {
            console.log('Ã¢Å“â€¦ Firebase Auth: User authenticated');
            setUser(userCredential.user);
            return firebase.firestore()
              .collection('users')
              .doc(userCredential.user.uid)
              .collection('sessions')
              .orderBy('date', 'desc')
              .get();
          })
          .then((snapshot) => {
            const sessionsData = [];
            snapshot.forEach(doc => {
              sessionsData.push({ id: doc.id, ...doc.data() });
            });
            console.log(`Ã¢Å“â€¦ Firestore: Loaded ${sessionsData.length} sessions`);
            setSessions(sessionsData);
            setLoading(false);
          })
          .catch((error) => {
            console.error('Ã¢Å’ Error:', error);
            setLoading(false);
          });
      }, []);

      // Filter sessions by time range
      const filteredSessions = useMemo(() => {
        if (sessions.length === 0) return [];

        let startDate;
        if (customStartDate && customEndDate) {
          startDate = new Date(customStartDate);
        } else if (timeRange === 'all') {
          return sessions;
        } else {
          startDate = new Date();
          startDate.setDate(startDate.getDate() - timeRange);
        }

        return sessions.filter(session => {
          const sessionDate = new Date(session.date);
          if (customStartDate && customEndDate) {
            const endDate = new Date(customEndDate);
            return sessionDate >= startDate && sessionDate <= endDate;
          }
          return sessionDate >= startDate;
        });
      }, [sessions, timeRange, customStartDate, customEndDate]);

      // Parse session date helper - MUST be before calculations
      const parseSessionDate = (dateStr) => {
        if (!dateStr) return new Date();
        if (dateStr.includes('/')) {
          const [day, month, year] = dateStr.split('/');
          return new Date(`${year}-${month}-${day}`);
        }
        return new Date(dateStr);
      };

      // TSS Calculation
      const calculateTSS = (session) => {
        const sessionType = session.sessionType || session.type;
        
        if (sessionType === 'Futsal') {
          const duration = session.duration || session.actual?.duration || 0;
          const rpe = session.rpe || session.actual?.rpe || 6;
          return Math.round((duration / 60) * 95 * (rpe / 8));
        }
        
        if (sessionType === 'Pedicab') {
          const duration = session.duration || session.actual?.duration || 0;
          const route = session.route || session.actual?.route || 'CBD-Docklands';
          const routeMultiplier = route === 'CBD-Docklands' ? 1.2 : 
                                  route === 'CBD-StKilda' ? 1.4 : 
                                  route === 'CBD-Southbank' ? 1.0 : 1.2;
          return Math.round((duration / 60) * 12 * routeMultiplier);
        }
        
        const distance = session.distance || session.actual?.distance || 0;
        const rpe = session.rpe || session.actual?.rpe || 6;
        
        if (distance === 0) return 0;
        return Math.round(distance * 6.5 * (rpe / 6));
      };

      // Calculate CTL (Chronic Training Load) - 42 day exponential average
      const calculateCTL = (sessions, targetDate) => {
        const date = new Date(targetDate);
        const relevantSessions = sessions.filter(s => {
          const sessionDate = parseSessionDate(s.date);
          const daysDiff = (date - sessionDate) / (1000 * 60 * 60 * 24);
          return daysDiff >= 0 && daysDiff < 42;
        });
        
        let ctl = 0;
        relevantSessions.forEach(session => {
          const sessionDate = parseSessionDate(session.date);
          const daysDiff = (date - sessionDate) / (1000 * 60 * 60 * 24);
          const weight = Math.exp(-daysDiff / 42);
          ctl += calculateTSS(session) * weight;
        });
        
        return Math.round(ctl / 42);
      };

      // Calculate ATL (Acute Training Load) - 7 day exponential average
      const calculateATL = (sessions, targetDate) => {
        const date = new Date(targetDate);
        const relevantSessions = sessions.filter(s => {
          const sessionDate = parseSessionDate(s.date);
          const daysDiff = (date - sessionDate) / (1000 * 60 * 60 * 24);
          return daysDiff >= 0 && daysDiff < 7;
        });
        
        let atl = 0;
        relevantSessions.forEach(session => {
          const sessionDate = parseSessionDate(session.date);
          const daysDiff = (date - sessionDate) / (1000 * 60 * 60 * 24);
          const weight = Math.exp(-daysDiff / 7);
          atl += calculateTSS(session) * weight;
        });
        
        return Math.round(atl / 7);
      };

      // Calculate current metrics
      const currentMetrics = useMemo(() => {
        // Safely convert to number, handling both strings and numbers
        const toNumber = (val) => {
          if (val === null || val === undefined) return 0;
          const num = parseFloat(val);
          return isNaN(num) ? 0 : num;
        };

        const totalSessions = filteredSessions.length;
        const totalDistance = filteredSessions.reduce((sum, s) => {
          const dist = toNumber(s.distance || s.actual?.distance);
          return sum + dist;
        }, 0);
        const totalTime = filteredSessions.reduce((sum, s) => {
          const duration = toNumber(s.duration || s.actual?.duration);
          return sum + duration;
        }, 0);

        // CRITICAL: Use ALL sessions for CTL/ATL, not filtered!
        const now = new Date();
        const ctl = calculateCTL(sessions, now);
        const atl = calculateATL(sessions, now);
        const tsb = ctl - atl;
        const acwr = ctl > 0 ? (atl / ctl).toFixed(2) : '0.00';

        return {
          totalSessions,
          totalDistance: totalDistance.toFixed(1),
          totalTime: Math.round(totalTime),
          ctl,
          atl,
          tsb,
          acwr
        };
      }, [filteredSessions, sessions]);

      // Calculate Z2 pace average
      const avgZ2Pace = useMemo(() => {
        const sessionsWithZ2 = filteredSessions.filter(s => {
          const pace = s.z2Pace || s.actual?.z2Pace;
          return pace && pace > 0;
        });

        if (sessionsWithZ2.length === 0) return 0;

        const totalPace = sessionsWithZ2.reduce((sum, s) => {
          const pace = s.z2Pace || s.actual?.z2Pace;
          return sum + pace;
        }, 0);

        return totalPace / sessionsWithZ2.length;
      }, [filteredSessions]);

      // Format pace
      const secondsToPace = (seconds) => {
        const mins = Math.floor(seconds / 60);
        const secs = Math.round(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
      };

      // Marathon prediction - correct formula
      const marathonPrediction = useMemo(() => {
        if (avgZ2Pace === 0) return '--:--:--';
        
        const marathonPaceSeconds = avgZ2Pace + 18; // Add 18 seconds per km
        const marathonTimeSeconds = marathonPaceSeconds * 42.195;
        const hours = Math.floor(marathonTimeSeconds / 3600);
        const minutes = Math.floor((marathonTimeSeconds % 3600) / 60);
        const seconds = Math.round(marathonTimeSeconds % 60);
        
        return `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }, [avgZ2Pace]);

      // Injury Risk Assessment
      const assessInjuryRisk = (acwr) => {
        const num = parseFloat(acwr);
        if (num < 0.8) return { level: 'Low', color: 'amber', message: 'Under-training' };
        if (num < 1.0) return { level: 'Optimal', color: 'emerald', message: 'Perfect balance' };
        if (num < 1.3) return { level: 'Moderate', color: 'amber', message: 'Slightly elevated' };
        return { level: 'High', color: 'rose', message: 'High injury risk' };
      };

      // Recovery Score Calculation (0-100)
      const calculateRecoveryScore = (tsb, acwr) => {
        let score = 50;
        if (tsb > 5) score += 30;
        else if (tsb > 0) score += 20;
        else if (tsb > -10) score += 10;
        
        const acwrNum = parseFloat(acwr);
        if (acwrNum >= 0.8 && acwrNum <= 1.0) score += 30;
        else if (acwrNum < 1.3) score += 20;
        else score += 10;
        
        return Math.min(100, Math.max(0, score));
      };

      // Calculate average cadence
      const avgCadence = useMemo(() => {
        const sessionsWithCadence = filteredSessions.filter(s => s.avgCadence);
        if (sessionsWithCadence.length === 0) return 0;
        
        const totalCadence = sessionsWithCadence.reduce((sum, s) => sum + s.avgCadence, 0);
        return Math.round(totalCadence / sessionsWithCadence.length);
      }, [filteredSessions]);

      // Injury risk assessment
      const injuryRisk = useMemo(() => {
        return assessInjuryRisk(currentMetrics.acwr);
      }, [currentMetrics.acwr]);

      // Recovery score (0-100 based on TSB and ACWR)
      const recoveryScore = useMemo(() => {
        return calculateRecoveryScore(currentMetrics.tsb, currentMetrics.acwr);
      }, [currentMetrics.tsb, currentMetrics.acwr]);

      // Recovery readiness level
      const recoveryReadiness = useMemo(() => {
        const score = recoveryScore;
        if (score >= 80) return { level: 'Excellent', score, color: '#10b981' };
        if (score >= 60) return { level: 'Good', score, color: '#3b82f6' };
        if (score >= 40) return { level: 'Fair', score, color: '#f59e0b' };
        return { level: 'Poor', score, color: '#f43f5e' };
      }, [recoveryScore]);

      // PMC Data for chart - use correct exponential decay calculation
      const pmcData = useMemo(() => {
        if (filteredSessions.length === 0) return [];

        const sortedSessions = [...filteredSessions].sort((a, b) => 
          parseSessionDate(a.date) - parseSessionDate(b.date)
        );

        const dataPoints = [];
        const startDate = parseSessionDate(sortedSessions[0].date);
        const endDate = new Date();
        
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
          const dateStr = d.toLocaleDateString('en-AU', { day: '2-digit', month: 'short' });
          
          const ctl = calculateCTL(sessions, d);
          const atl = calculateATL(sessions, d);
          const tsb = ctl - atl;
          
          dataPoints.push({ date: dateStr, CTL: ctl, ATL: atl, TSB: tsb });
        }

        // Downsample if too many points
        if (dataPoints.length > 30) {
          return dataPoints.filter((_, i) => i % 3 === 0);
        }
        return dataPoints;
      }, [filteredSessions, sessions]);

      // Helper function to get week number (MUST be before usage)
      const getWeekNumber = (date) => {
        const d = new Date(date);
        d.setHours(0, 0, 0, 0);
        d.setDate(d.getDate() + 4 - (d.getDay() || 7));
        const yearStart = new Date(d.getFullYear(), 0, 1);
        const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        return weekNo;
      };

      // Weekly Volume Data - Use training weeks, not ISO weeks
      const weeklyVolumeData = useMemo(() => {
        // Get training start date
        const trainingStartDate = new Date('2025-11-10');
        const today = new Date();
        
        // Filter sessions from training start onwards
        const trainingSessions = sessions.filter(s => {
          const sessionDate = parseSessionDate(s.date);
          return sessionDate >= trainingStartDate;
        });
        
        if (trainingSessions.length === 0) return [];

        const weeks = {};
        trainingSessions.forEach(session => {
          const sessionDate = parseSessionDate(session.date);
          
          // Calculate training week number (Week 1 = first week after Nov 10)
          const daysSinceStart = Math.floor((sessionDate - trainingStartDate) / (1000 * 60 * 60 * 24));
          const trainingWeek = Math.floor(daysSinceStart / 7) + 1;
          
          if (!weeks[trainingWeek]) {
            weeks[trainingWeek] = { 
              week: `W${trainingWeek}`, 
              distance: 0, 
              tss: 0,
              date: sessionDate
            };
          }
          const distance = session.distance || session.actual?.distance || 0;
          weeks[trainingWeek].distance += distance;
          weeks[trainingWeek].tss += calculateTSS(session);
        });

        const weekArray = Object.values(weeks).sort((a, b) => {
          const weekA = parseInt(a.week.substring(1));
          const weekB = parseInt(b.week.substring(1));
          return weekA - weekB;
        });

        return weekArray;
      }, [sessions]);

      // Pace Progression Data - Use training weeks
      const paceProgressionData = useMemo(() => {
        const trainingStartDate = new Date('2025-11-10');
        
        const trainingSessions = sessions.filter(s => {
          const sessionDate = parseSessionDate(s.date);
          return sessionDate >= trainingStartDate;
        });
        
        const weeks = {};
        
        trainingSessions.forEach(session => {
          const z2Pace = session.z2Pace || session.actual?.z2Pace;
          
          if (z2Pace && z2Pace > 0) {
            const sessionDate = parseSessionDate(session.date);
            
            // Calculate training week number
            const daysSinceStart = Math.floor((sessionDate - trainingStartDate) / (1000 * 60 * 60 * 24));
            const trainingWeek = Math.floor(daysSinceStart / 7) + 1;
            const weekKey = `W${trainingWeek}`;
            
            if (!weeks[weekKey]) {
              weeks[weekKey] = { 
                week: weekKey, 
                totalPace: 0, 
                count: 0,
                weekNum: trainingWeek,
                date: sessionDate
              };
            }
            weeks[weekKey].totalPace += z2Pace;
            weeks[weekKey].count += 1;
          }
        });

        const weekArray = Object.values(weeks)
          .filter(w => w.count > 0)
          .map(w => ({
            week: w.week,
            pace: w.totalPace / w.count,
            weekNum: w.weekNum
          }))
          .sort((a, b) => a.weekNum - b.weekNum);

        return weekArray;
      }, [sessions]);

      // Session Type Distribution Data
      const sessionTypeData = useMemo(() => {
        const types = {};
        filteredSessions.forEach(session => {
          const type = session.sessionType;
          if (!types[type]) types[type] = 0;
          types[type] += 1;
        });
        return Object.entries(types).map(([type, count]) => ({ name: type, value: count }));
      }, [filteredSessions]);

      // Help modal content
      const helpContent = {
        sessions: {
          title: 'Total Sessions',
          description: 'Number of training sessions in the selected time period.',
          interpretation: 'More sessions = more training consistency.',
          formula: 'Count of all logged sessions'
        },
        volume: {
          title: 'Training Volume',
          description: 'Total distance covered in running sessions.',
          interpretation: 'â€¢ <30km/week: Maintenance\nâ€¢ 30-50km/week: Base building\nâ€¢ 50-70km/week: Marathon training\nâ€¢ >70km/week: High volume',
          formula: 'Sum of all session distances'
        },
        pace: {
          title: 'Average Zone 2 Pace',
          description: 'Your average easy run pace in Zone 2 (conversational effort).',
          interpretation: 'Faster Z2 pace = improved aerobic efficiency. Track this monthly.',
          formula: 'Average of z2Pace field across all runs'
        },
        marathon: {
          title: 'Marathon Time Prediction',
          description: 'Estimated marathon finish time based on your current fitness.',
          interpretation: 'Based on Z2 pace + 8% marathon pace penalty. Requires CTL > 50.',
          formula: 'Z2 pace Ã— 1.08 Ã— 42.195km'
        },
        ctl: {
          title: 'CTL - Chronic Training Load (Fitness)',
          description: 'Your long-term training load averaged over 42 days.',
          interpretation: 'â€¢ <40: Building base\nâ€¢ 40-60: Marathon ready\nâ€¢ 60-80: High fitness\nâ€¢ >80: Elite level',
          formula: 'Exponential weighted moving average (42 days)'
        },
        atl: {
          title: 'ATL - Acute Training Load (Fatigue)',
          description: 'Your short-term training load averaged over 7 days.',
          interpretation: 'High ATL after hard weeks. Should drop during recovery weeks.',
          formula: 'Exponential weighted moving average (7 days)'
        },
        tsb: {
          title: 'TSB - Training Stress Balance (Form)',
          description: 'Difference between fitness and fatigue. Indicates readiness.',
          interpretation: 'â€¢ <-30: Overreached\nâ€¢ -10 to 0: Training hard\nâ€¢ 0 to 5: Optimal for training\nâ€¢ >5: Well recovered, race ready',
          formula: 'CTL - ATL'
        },
        acwr: {
          title: 'ACWR - Acute:Chronic Workload Ratio',
          description: 'Ratio of recent training load to long-term average.',
          interpretation: 'â€¢ <0.8: Undertrained\nâ€¢ 0.8-1.3: Optimal range\nâ€¢ >1.3: Injury risk zone',
          formula: 'ATL / CTL'
        },
        cadence: {
          title: 'Running Economy - Cadence',
          description: 'Your average stride rate (steps per minute) indicating running efficiency.',
          interpretation: 'â€¢ <165 spm: Low - Increase stride rate\nâ€¢ 165-180 spm: Optimal range\nâ€¢ >180 spm: High - May indicate overstriding',
          formula: 'Average of avgCadence across all running sessions'
        },
        weeklyVolume: {
          title: 'Weekly Volume Trend',
          description: 'Total distance run each week over the last 3 months.',
          interpretation: 'Consistent volume with gradual increases (10% rule) reduces injury risk. Watch for sudden spikes.',
          formula: 'Sum of distances per week (W = ISO week number)'
        },
        paceProgression: {
          title: 'Pace Progression (Z2)',
          description: 'Average Zone 2 pace improvement over time.',
          interpretation: 'Faster Z2 pace (lower numbers) = better aerobic fitness. Consistent improvement shows training is working.',
          formula: 'Weekly average of z2Pace field'
        },
        sessionDistribution: {
          title: 'Session Type Distribution',
          description: 'Breakdown of training sessions by type (Run, Futsal, Pedicab, etc.).',
          interpretation: 'Balanced training includes variety. Too much of one type can lead to overuse injuries.',
          formula: 'Count of each sessionType'
        },
        tsbGauge: {
          title: 'Training Load Balance (TSB)',
          description: 'Visual representation of your current form state on a spectrum from underloaded to overloaded.',
          interpretation: 'â€¢ Left (Red): Underloaded/Detraining\nâ€¢ Center (Green): Optimal training zone\nâ€¢ Right (Blue): Well recovered, race-ready\nâ€¢ Far Right: Risk of detraining',
          formula: 'CTL - ATL plotted on scale from -30 to +30'
        }
      };

      const showHelpModal = (topic) => {
        setHelpTopic(topic);
        setShowHelp(true);
      };

      if (loading) {
        return (
          <div className="flex items-center justify-center" style={{ height: '100vh' }}>
            <div className="text-center">
              <div className="spinner mx-auto mb-4"></div>
              <p className="text-slate-400">Loading analytics...</p>
            </div>
          </div>
        );
      }

      return (
        <div>
          {/* Main Content */}
          <div className="p-4 md:p-8">
            <div className="max-w-7xl mx-auto">
              {/* Compact Header */}
              <div className="mb-4 fade-in">
                <h1 className="text-2xl md:text-3xl font-bold gradient-text mb-3">
                  ðŸ“Š Analytics Dashboard
                </h1>
                
                <div className="date-header">
                  <div className="flex justify-between items-start">
                    <div>
                      <p className="text-xs text-slate-400 uppercase tracking-wide mb-1">Today</p>
                      <p className="text-sm font-semibold text-white">
                        {new Date().toLocaleDateString('en-AU', { weekday: 'long', day: 'numeric', month: 'short' })}
                      </p>
                    </div>
                    <div className="text-right">
                      <p className="text-xs text-slate-400 uppercase tracking-wide mb-1">Training Week</p>
                      <p className="text-sm font-semibold text-blue-400">
                        Week {getCurrentTrainingWeek()}
                      </p>
                    </div>
                  </div>
                </div>
              </div>

              {/* QUICK FILTER PILLS */}
              <div className="fade-in mb-4">
                <div className="filter-pills">
                  <button 
                    className={`filter-pill ${timeRange === 7 ? 'active' : ''}`}
                    onClick={() => { setTimeRange(7); setCustomStartDate(''); setCustomEndDate(''); }}
                  >
                    7D
                  </button>
                  <button 
                    className={`filter-pill ${timeRange === 30 ? 'active' : ''}`}
                    onClick={() => { setTimeRange(30); setCustomStartDate(''); setCustomEndDate(''); }}
                  >
                    30D
                  </button>
                  <button 
                    className={`filter-pill ${timeRange === 90 ? 'active' : ''}`}
                    onClick={() => { setTimeRange(90); setCustomStartDate(''); setCustomEndDate(''); }}
                  >
                    3M
                  </button>
                  <button 
                    className={`filter-pill ${timeRange === 365 ? 'active' : ''}`}
                    onClick={() => { setTimeRange(365); setCustomStartDate(''); setCustomEndDate(''); }}
                  >
                    1Y
                  </button>
                  <button 
                    className={`filter-pill ${timeRange === 'all' ? 'active' : ''}`}
                    onClick={() => { setTimeRange('all'); setCustomStartDate(''); setCustomEndDate(''); }}
                  >
                    All
                  </button>
                  <button 
                    className="filter-pill"
                    onClick={() => setShowAdvancedFilters(!showAdvancedFilters)}
                  >
                    {showAdvancedFilters ? 'â–¼' : 'â–¶'} Advanced
                  </button>
                </div>
                
                {/* Advanced Filters (Collapsible) */}
                <div className={`advanced-filters ${showAdvancedFilters ? 'expanded' : ''}`}>
                  <div className="grid grid-cols-2 gap-3 mt-3 p-4 bg-slate-800/30 rounded-lg">
                    <div>
                      <label className="block text-xs text-slate-400 mb-1">From</label>
                      <input 
                        type="date" 
                        value={customStartDate}
                        onChange={(e) => setCustomStartDate(e.target.value)}
                        className="w-full"
                      />
                    </div>
                    <div>
                      <label className="block text-xs text-slate-400 mb-1">To</label>
                      <input 
                        type="date" 
                        value={customEndDate}
                        onChange={(e) => setCustomEndDate(e.target.value)}
                        className="w-full"
                      />
                    </div>
                  </div>
                </div>
              </div>

              {/* SECTION 1: COMPACT OVERVIEW METRICS (2x2 grid on mobile) */}
              <div className="mb-6 fade-in">
                <div className="flex items-center gap-2 mb-3">
                  <h2 className="text-lg font-bold">ðŸ“Š Overview</h2>
                </div>
                
                <div className="grid grid-cols-2 gap-3">
                  {/* Sessions */}
                  <div className="metric-card">
                    <div className="flex items-center justify-between mb-1">
                      <h3 className="text-xs font-semibold text-slate-400">Sessions</h3>
                      <HelpButton helpKey="sessions" onClick={showHelpModal} />
                    </div>
                    <div className="text-2xl font-bold text-purple-400 mb-1">
                      <AnimatedNumber value={currentMetrics.totalSessions} />
                    </div>
                    <p className="text-xs text-slate-500">Total</p>
                  </div>

                  {/* Volume */}
                  <div className="metric-card">
                    <div className="flex items-center justify-between mb-1">
                      <h3 className="text-xs font-semibold text-slate-400">Volume</h3>
                      <HelpButton helpKey="volume" onClick={showHelpModal} />
                    </div>
                    <div className="text-2xl font-bold text-cyan-400 mb-1">
                      <AnimatedNumber value={parseFloat(currentMetrics.totalDistance)} decimals={1} />km
                    </div>
                    <p className="text-xs text-slate-500">{Math.round(currentMetrics.totalTime / 60)}h</p>
                  </div>

                  {/* Avg Pace */}
                  <div className="metric-card">
                    <div className="flex items-center justify-between mb-1">
                      <h3 className="text-xs font-semibold text-slate-400">Z2 Pace</h3>
                      <HelpButton helpKey="pace" onClick={showHelpModal} />
                    </div>
                    <div className="text-2xl font-bold text-indigo-400 mb-1 mono">
                      {avgZ2Pace > 0 ? secondsToPace(avgZ2Pace) : '--:--'}
                    </div>
                    <p className="text-xs text-slate-500">/km</p>
                  </div>

                  {/* Marathon Prediction */}
                  <div className="metric-card">
                    <div className="flex items-center justify-between mb-1">
                      <h3 className="text-xs font-semibold text-slate-400">Marathon</h3>
                      <HelpButton helpKey="marathon" onClick={showHelpModal} />
                    </div>
                    <div className="text-2xl font-bold text-emerald-400 mb-1 mono">{marathonPrediction}</div>
                    <p className="text-xs text-slate-500">Prediction</p>
                  </div>
                </div>
              </div>

              {/* SECTION 2: COMPACT TRAINING LOAD (2x2 grid) */}
              <div className="mb-6 fade-in">
                <div className="flex items-center gap-2 mb-3">
                  <h2 className="text-lg font-bold">âš¡ Training Load</h2>
                </div>
                
                <div className="grid grid-cols-2 gap-3">
                  {/* CTL */}
                  <div className="metric-card">
                    <div className="flex items-center justify-between mb-1">
                      <h3 className="text-xs font-semibold text-slate-400">CTL</h3>
                      <HelpButton helpKey="ctl" onClick={showHelpModal} />
                    </div>
                    <div className="text-2xl font-bold text-blue-400 mb-1">
                      <AnimatedNumber value={currentMetrics.ctl} />
                    </div>
                    <p className="text-xs text-slate-500">Fitness</p>
                  </div>

                  {/* ATL */}
                  <div className="metric-card">
                    <div className="flex items-center justify-between mb-1">
                      <h3 className="text-xs font-semibold text-slate-400">ATL</h3>
                      <HelpButton helpKey="atl" onClick={showHelpModal} />
                    </div>
                    <div className="text-2xl font-bold text-amber-400 mb-1">
                      <AnimatedNumber value={currentMetrics.atl} />
                    </div>
                    <p className="text-xs text-slate-500">Fatigue</p>
                  </div>

                  {/* TSB */}
                  <div className="metric-card">
                    <div className="flex items-center justify-between mb-1">
                      <h3 className="text-xs font-semibold text-slate-400">TSB</h3>
                      <HelpButton helpKey="tsb" onClick={showHelpModal} />
                    </div>
                    <div className={`text-2xl font-bold mb-1 ${currentMetrics.tsb > 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
                      {currentMetrics.tsb > 0 ? '+' : ''}<AnimatedNumber value={currentMetrics.tsb} />
                    </div>
                    <p className="text-xs text-slate-500">Form</p>
                  </div>

                  {/* ACWR */}
                  <div className="metric-card">
                    <div className="flex items-center justify-between mb-1">
                      <h3 className="text-xs font-semibold text-slate-400">ACWR</h3>
                      <HelpButton helpKey="acwr" onClick={showHelpModal} />
                    </div>
                    <div className="text-2xl font-bold text-purple-400 mb-1">
                      {currentMetrics.acwr}
                    </div>
                    <p className="text-xs text-slate-500">Ratio</p>
                  </div>
                </div>
              </div>

              {/* SECTION 2.5: RUNNING ECONOMY - COMPACT */}
              <div className="mb-6 fade-in">
                <div className="card p-4">
                  <div className="flex items-center justify-between">
                    {/* Left side: Icon and title */}
                    <div className="flex items-center gap-3">
                      <span className="text-2xl">ðŸƒ</span>
                      <div>
                        <div className="flex items-center gap-2">
                          <h3 className="text-sm font-semibold text-slate-300">Running Economy</h3>
                          <HelpButton helpKey="cadence" onClick={showHelpModal} />
                        </div>
                        <p className="text-xs text-slate-500">Avg Cadence</p>
                      </div>
                    </div>
                    
                    {/* Right side: Value and status */}
                    <div className="text-right">
                      {avgCadence === 0 ? (
                        <div className="text-xl text-slate-500">--</div>
                      ) : (
                        <>
                          <div className="text-2xl font-bold text-cyan-400 mono">
                            {avgCadence}<span className="text-sm text-slate-400 ml-1">spm</span>
                          </div>
                          <div className={`text-xs font-semibold ${
                            avgCadence < 165 ? 'text-amber-400' : 
                            avgCadence > 180 ? 'text-amber-400' : 
                            'text-emerald-400'
                          }`}>
                            {avgCadence < 165 ? 'Low' : avgCadence > 180 ? 'High' : 'Optimal'}
                          </div>
                        </>
                      )}
                    </div>
                  </div>
                  
                  {avgCadence > 0 && avgCadence < 165 && (
                    <div className="mt-3 text-xs text-amber-300 bg-amber-900/20 border border-amber-700/30 rounded p-2">
                      âš ï¸ Low cadence increases injury risk. Target: 165-180 spm
                    </div>
                  )}
                </div>
              </div>

              {/* SECTION 3: RISK & RECOVERY GAUGES - COMPACT SIDE BY SIDE */}
              <div className="mb-6 fade-in">
                <div className="flex items-center gap-2 mb-3">
                  <h2 className="text-lg font-bold">ðŸŽ¯ Risk & Recovery</h2>
                </div>
                
                <div className="card p-4">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {/* LEFT: Injury Risk - Horizontal Gauge */}
                    <div>
                      <div className="flex items-center justify-between mb-2">
                        <span className="text-sm font-semibold text-slate-300">Injury Risk (ACWR)</span>
                        <HelpButton helpKey="acwr" onClick={showHelpModal} />
                      </div>
                      
                      {/* Horizontal bar - compact */}
                      <div className="relative h-8 bg-slate-800/50 rounded-full overflow-hidden mb-2">
                        {/* Zone colors */}
                        <div className="absolute inset-0 flex">
                          <div className="w-1/4 bg-gradient-to-r from-amber-500/30 to-amber-500/20"></div>
                          <div className="flex-1 bg-gradient-to-r from-emerald-500/30 to-emerald-500/20"></div>
                          <div className="w-1/4 bg-gradient-to-r from-amber-500/20 to-rose-500/30"></div>
                        </div>
                        
                        {/* Marker for ACWR value */}
                        {(() => {
                          const acwr = parseFloat(currentMetrics.acwr);
                          // Map ACWR range 0.5-1.5 to 0-100%
                          const percentage = Math.max(0, Math.min(100, ((acwr - 0.5) / 1.0) * 100));
                          const markerColor = injuryRisk.color === 'emerald' ? '#10b981' : 
                                             injuryRisk.color === 'amber' ? '#f59e0b' : '#f43f5e';
                          
                          return (
                            <div 
                              className="absolute top-0 bottom-0 w-1 bg-white shadow-lg transition-all duration-500"
                              style={{ left: `${percentage}%`, transform: 'translateX(-50%)' }}
                            >
                              <div className="absolute -top-1 left-1/2 -translate-x-1/2 w-3 h-3 rounded-full bg-white shadow-lg border-2" style={{ borderColor: markerColor }}></div>
                              <div className="absolute -bottom-1 left-1/2 -translate-x-1/2 w-3 h-3 rounded-full bg-white shadow-lg border-2" style={{ borderColor: markerColor }}></div>
                            </div>
                          );
                        })()}
                      </div>
                      
                      {/* Value and labels */}
                      <div className="flex justify-between items-center text-xs text-slate-500 mb-2">
                        <span>Under (&lt;0.8)</span>
                        <span>High (&gt;1.3)</span>
                      </div>
                      
                      <div className="text-center">
                        <div className="text-2xl font-bold mono" style={{ color: injuryRisk.color === 'emerald' ? '#10b981' : injuryRisk.color === 'amber' ? '#f59e0b' : '#f43f5e' }}>
                          {currentMetrics.acwr}
                        </div>
                        <div className="text-xs font-semibold" style={{ color: injuryRisk.color === 'emerald' ? '#10b981' : injuryRisk.color === 'amber' ? '#f59e0b' : '#f43f5e' }}>
                          {injuryRisk.level}
                        </div>
                      </div>
                    </div>
                    
                    {/* RIGHT: Recovery Readiness - Circular Gauge */}
                    <div>
                      <div className="flex items-center justify-between mb-2">
                        <span className="text-sm font-semibold text-slate-300">Recovery Readiness</span>
                        <HelpButton helpKey="tsb" onClick={showHelpModal} />
                      </div>
                      
                      {/* Circular gauge */}
                      <div className="flex flex-col items-center">
                        <div className="relative" style={{ width: '120px', height: '120px' }}>
                          <svg width="120" height="120" viewBox="0 0 120 120">
                            {/* Background circle */}
                            <circle
                              cx="60"
                              cy="60"
                              r="50"
                              fill="none"
                              stroke="#1e293b"
                              strokeWidth="12"
                            />
                            
                            {/* Progress arc */}
                            <circle
                              cx="60"
                              cy="60"
                              r="50"
                              fill="none"
                              stroke={recoveryReadiness.color}
                              strokeWidth="12"
                              strokeDasharray={2 * Math.PI * 50}
                              strokeDashoffset={2 * Math.PI * 50 - (recoveryScore / 100) * 2 * Math.PI * 50}
                              strokeLinecap="round"
                              transform="rotate(-90 60 60)"
                              style={{ transition: 'stroke-dashoffset 0.5s ease' }}
                            />
                            
                            {/* Marker pointer at current position */}
                            {(() => {
                              const angle = -90 + (recoveryScore / 100) * 360;
                              const radians = (angle * Math.PI) / 180;
                              const markerX = 60 + 50 * Math.cos(radians);
                              const markerY = 60 + 50 * Math.sin(radians);
                              
                              return (
                                <>
                                  <circle
                                    cx={markerX}
                                    cy={markerY}
                                    r="6"
                                    fill="white"
                                    stroke={recoveryReadiness.color}
                                    strokeWidth="3"
                                  />
                                </>
                              );
                            })()}
                          </svg>
                          
                          {/* Center text */}
                          <div className="absolute inset-0 flex flex-col items-center justify-center">
                            <div className="text-2xl font-bold mono" style={{ color: recoveryReadiness.color }}>
                              {recoveryScore}
                            </div>
                            <div className="text-xs text-slate-400">/ 100</div>
                          </div>
                        </div>
                        
                        {/* Status label */}
                        <div className="mt-2 text-center">
                          <div className="text-xs font-semibold" style={{ color: recoveryReadiness.color }}>
                            {recoveryReadiness.level}
                          </div>
                          <div className="text-xs text-slate-500">
                            {recoveryScore < 40 ? 'Poor' : recoveryScore < 60 ? 'Fair' : recoveryScore < 80 ? 'Good' : 'Excellent'}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* SECTION 4: PERFORMANCE TRENDS - 3 CHARTS */}
              <div className="mb-6 fade-in">
                <div className="flex items-center gap-2 mb-3">
                  <h2 className="text-lg font-bold">ðŸ“ˆ Performance Trends</h2>
                </div>

                {/* Weekly Volume & Pace Progression side by side */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  {/* Weekly Volume */}
                  <div className="card p-4">
                    <div className="flex items-center justify-between mb-3">
                      <h3 className="text-md font-bold">Weekly Volume</h3>
                      <HelpButton helpKey="weeklyVolume" onClick={showHelpModal} />
                    </div>
                    
                    {weeklyVolumeData.length > 0 ? (
                      <ResponsiveContainer width="100%" height={220}>
                        <BarChart 
                          data={weeklyVolumeData}
                          margin={{ top: 5, right: 10, left: -15, bottom: 5 }}
                        >
                          <CartesianGrid strokeDasharray="3 3" stroke="#334155" />
                          <XAxis 
                            dataKey="week" 
                            stroke="#94a3b8" 
                            style={{ fontSize: '11px' }} 
                          />
                          <YAxis 
                            stroke="#94a3b8" 
                            style={{ fontSize: '11px' }}
                          />
                          <Tooltip
                            contentStyle={{ background: '#1a2332', border: '1px solid #334155', borderRadius: '8px' }}
                            formatter={(value) => [`${value.toFixed(1)} km`, 'Distance']}
                          />
                          <Bar 
                            dataKey="distance" 
                            fill="#10b981" 
                            name="Distance (km)"
                            radius={[8, 8, 0, 0]}
                            maxBarSize={50}
                          />
                        </BarChart>
                      </ResponsiveContainer>
                    ) : (
                      <div className="h-[220px] flex items-center justify-center text-slate-500">
                        <p className="text-xs">No weekly data available</p>
                      </div>
                    )}
                  </div>

                  {/* Pace Progression (Z2) */}
                  <div className="card p-4">
                    <div className="flex items-center justify-between mb-3">
                      <h3 className="text-md font-bold">Pace Progression (Z2)</h3>
                      <HelpButton helpKey="paceProgression" onClick={showHelpModal} />
                    </div>
                    
                    {paceProgressionData.length > 0 ? (
                      <ResponsiveContainer width="100%" height={220}>
                        <LineChart 
                          data={paceProgressionData}
                          margin={{ top: 5, right: 10, left: -15, bottom: 5 }}
                        >
                          <CartesianGrid strokeDasharray="3 3" stroke="#334155" />
                          <XAxis 
                            dataKey="week" 
                            stroke="#94a3b8" 
                            style={{ fontSize: '11px' }} 
                          />
                          <YAxis 
                            stroke="#94a3b8" 
                            style={{ fontSize: '11px' }}
                            tickFormatter={(value) => secondsToPace(value)}
                            domain={['auto', 'auto']}
                            reversed={true}
                          />
                          <Tooltip
                            contentStyle={{ background: '#1a2332', border: '1px solid #334155', borderRadius: '8px' }}
                            formatter={(value) => [secondsToPace(value), 'Avg Pace']}
                            labelFormatter={(label) => `Week ${label.substring(1)}`}
                          />
                          <Line 
                            type="monotone" 
                            dataKey="pace" 
                            stroke="#3b82f6" 
                            strokeWidth={2} 
                            name="Avg Pace"
                            dot={{ fill: '#3b82f6', r: 3 }}
                            activeDot={{ r: 5 }}
                          />
                        </LineChart>
                      </ResponsiveContainer>
                    ) : (
                      <div className="h-[220px] flex items-center justify-center text-slate-500">
                        <p className="text-xs">No Z2 pace data available</p>
                      </div>
                    )}
                  </div>
                </div>

                {/* Session Distribution - Full Width */}
                <div className="card p-4">
                  <div className="flex items-center justify-between mb-3">
                    <h3 className="text-md font-bold">Session Distribution</h3>
                    <HelpButton helpKey="sessionDistribution" onClick={showHelpModal} />
                  </div>

                  {sessionTypeData.length > 0 ? (
                    <ResponsiveContainer width="100%" height={250}>
                      <PieChart>
                        <Pie
                          data={sessionTypeData}
                          cx="50%"
                          cy="50%"
                          labelLine={false}
                          label={({ name, percent }) => `${name}: ${(percent * 100).toFixed(0)}%`}
                          outerRadius={80}
                          fill="#8884d8"
                          dataKey="value"
                        >
                          {sessionTypeData.map((entry, index) => (
                            <Cell key={`cell-${index}`} fill={['#3b82f6', '#10b981', '#f59e0b', '#f43f5e', '#8b5cf6'][index % 5]} />
                          ))}
                        </Pie>
                        <Tooltip contentStyle={{ background: '#1a2332', border: '1px solid #334155', borderRadius: '8px' }} />
                      </PieChart>
                    </ResponsiveContainer>
                  ) : (
                    <div className="h-[250px] flex items-center justify-center text-slate-500">
                      <p className="text-xs">No session data available</p>
                    </div>
                  )}
                </div>
              </div>

              {/* SECTION 5: PERFORMANCE MANAGEMENT CHART (Moved to bottom) */}
              <div className="mb-6 fade-in">
                <div className="flex items-center gap-2 mb-3">
                  <h2 className="text-lg font-bold">ðŸ“ˆ Performance Management Chart</h2>
                  <HelpButton helpKey="ctl" onClick={showHelpModal} />
                </div>
                <div className="card p-4">
                  <p className="text-sm text-slate-400 mb-4">42/7-day CTL/ATL/TSB trend - Essential for peaking strategy</p>
                  
                  {pmcData.length === 0 ? (
                    <div className="text-center py-12">
                      <p className="text-slate-500">No data available for selected time range</p>
                      <p className="text-xs text-slate-600 mt-2">Add more sessions to see the trend</p>
                    </div>
                  ) : (
                    <ResponsiveContainer width="100%" height={300}>
                      <LineChart data={pmcData} margin={{ top: 5, right: 5, left: -20, bottom: 5 }}>
                        <CartesianGrid strokeDasharray="3 3" stroke="#334155" />
                        <XAxis 
                          dataKey="date" 
                          stroke="#94a3b8"
                          tick={{ fontSize: 11 }}
                          interval="preserveStartEnd"
                        />
                        <YAxis 
                          stroke="#94a3b8"
                          tick={{ fontSize: 11 }}
                        />
                        <Tooltip 
                          contentStyle={{ 
                            background: '#1a2332', 
                            border: '1px solid #334155',
                            borderRadius: '8px'
                          }}
                        />
                        <Legend 
                          wrapperStyle={{ fontSize: '12px' }}
                        />
                        <Line 
                          type="monotone" 
                          dataKey="CTL" 
                          stroke="#3b82f6" 
                          strokeWidth={2}
                          dot={false}
                          name="Fitness (CTL)"
                        />
                        <Line 
                          type="monotone" 
                          dataKey="ATL" 
                          stroke="#f59e0b" 
                          strokeWidth={2}
                          dot={false}
                          name="Fatigue (ATL)"
                        />
                        <Line 
                          type="monotone" 
                          dataKey="TSB" 
                          stroke="#10b981" 
                          strokeWidth={2}
                          dot={false}
                          name="Form (TSB)"
                        />
                      </LineChart>
                    </ResponsiveContainer>
                  )}
                </div>
              </div>

            </div>
          </div>

          {/* Bottom Navigation */}
          <BottomNav currentPage="analytics" />

          {/* Help Modal */}
          {showHelp && (
            <div className="fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4" onClick={() => setShowHelp(false)}>
              <div className="card p-6 max-w-md w-full" onClick={(e) => e.stopPropagation()}>
                <h3 className="text-xl font-bold mb-3">{helpContent[helpTopic]?.title}</h3>
                <p className="text-sm text-slate-300 mb-3">{helpContent[helpTopic]?.description}</p>
                <div className="bg-slate-800 p-3 rounded mb-3">
                  <p className="text-xs text-slate-400 whitespace-pre-line">{helpContent[helpTopic]?.interpretation}</p>
                </div>
                <p className="text-xs text-slate-500 mb-4">Formula: {helpContent[helpTopic]?.formula}</p>
                <button className="btn-primary w-full" onClick={() => setShowHelp(false)}>Got it</button>
              </div>
            </div>
          )}
        </div>
      );
    }

    // Render App
    ReactDOM.render(<AnalyticsDashboard />, document.getElementById('root'));
  </script>
</body>
</html>
